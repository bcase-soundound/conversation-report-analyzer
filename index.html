<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Report Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevent body from scrolling horizontally */
        }
        /* Custom scrollbar for filter sidebar */
        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Ensure the main content area can scroll if needed, but the table has its own scroll */
        .main-content {
            height: 100vh;
            display: flex;
            flex-direction: column;
            min-width: 0; /* CRITICAL FIX: Prevents flex item from overflowing its container */
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-root"></div>
    <div id="modal-root"></div>

    <script type="module">
        // --- STATE MANAGEMENT ---
        let state = {
            data: [],
            filteredData: [], // Memoized filtered data
            headers: [],
            customMetricKeys: [],
            summaryStats: { timeRange: 'N/A', uniqueDomains: 0, peakConcurrency: 0, totalContained: 0, avgHandleTime: '00:00' }, // Pre-calculated stats
            filters: {},
            fileName: '',
            error: '',
            isLoading: false,
            isSidebarOpen: true,
            sortConfig: { key: null, direction: 'ascending' },
            pagination: { currentPage: 1, rowsPerPage: 100 },
            mainChartInstance: null,
            consumptionAnalysisState: { // State for the new modal
                dailyChart: null,
                weeklyChart: null,
                containmentChart: null,
                handleTimeChart: null,
                originalData: [],
            },
        };

        // --- ICONS ---
        const icons = {
            uploadCloud: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>`,
            file: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            download: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
            filter: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>`,
            search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`,
            chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`,
            chevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
        };

        const appRoot = document.getElementById('app-root');
        const modalRoot = document.getElementById('modal-root');
        let fileParserWorker;

        // --- RENDER & UPDATE FUNCTIONS ---
        
        function renderApp() {
            if (state.isLoading) {
                 appRoot.innerHTML = renderUploader();
                 return;
            }
            if (state.data.length === 0) {
                appRoot.innerHTML = renderUploader();
                setupUploaderEventListeners();
            } else {
                appRoot.innerHTML = renderDashboard();
                setupDashboardEventListeners();
            }
        }
        
        // OPTIMIZED: This function now only updates the necessary parts of the UI
        function updateUI() {
            updateSummaryPanel();
            updateMainChart();
            updateDataTable();
            updateSidebarButtons();
            updateHeader();
        }

        function renderUploader() {
            if (state.isLoading) {
                return `<div class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4 text-center"><div class="loader"></div><p class="text-lg font-semibold text-gray-700 mt-4">Processing your file...</p></div>`;
            }
            return `<div class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4 text-center"><div id="dropzone" class="w-full max-w-lg p-10 border-2 border-dashed rounded-xl cursor-pointer transition-colors border-gray-300 bg-white hover:bg-gray-100"><div class="flex flex-col items-center justify-center space-y-4 pointer-events-none"><div class="bg-blue-100 p-4 rounded-full"><span class="w-10 h-10 text-blue-600 inline-block">${icons.uploadCloud.replace('width="24"','width="40"').replace('height="24"','height="40"')}</span></div><p class="text-lg font-semibold text-gray-700">Drag & drop your CSV file here</p><p class="text-sm text-gray-500">or</p><button class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">Browse files</button><p class="text-xs text-gray-400 mt-2">Only *.csv files are accepted</p></div></div>${state.error ? `<p class="text-red-500 mt-4">${state.error}</p>` : ''}<div class="mt-8 text-left max-w-lg w-full"><h3 class="text-xl font-bold text-gray-800 mb-2">Welcome to the Conversation Analyzer</h3><p class="text-gray-600">This tool helps you process and analyze conversation reports. Simply upload your CSV file to get started.</p></div></div>`;
        }

        function renderDashboard() {
            return `<div class="min-h-screen font-sans flex">${renderSidebar()}<main class="flex-1 p-6 md:p-8 main-content">${renderHeader()}<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-shrink-0"><div class="lg:col-span-2">${renderSummaryPanel()}</div><div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">${renderMainChart()}</div></div><div class="mt-6 bg-white rounded-xl shadow-md flex-grow flex flex-col overflow-hidden">${renderDataTable()}</div></main></div>`;
        }

        function renderSidebar() {
            const options = getFilterOptions();
            const standardKeys = Object.keys(options).filter(k => !state.customMetricKeys.includes(k));
            const customKeys = Object.keys(options).filter(k => state.customMetricKeys.includes(k));
            
            const renderMultiSelect = (key, values) => {
                const selectedValues = state.filters[key] || [];
                const optionsHTML = values.map(val => `
                    <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-gray-100">
                        <input type="checkbox" data-filter-key="${key}" value="${val}" ${selectedValues.includes(val) ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-sm text-gray-700">${val}</span>
                    </label>
                `).join('');
                return `<div class="pl-2 mt-1 space-y-1 max-h-48 overflow-y-auto pr-2 hidden">${optionsHTML}</div>`;
            };

            const renderFilterGroup = (key, values) => `
                <div>
                    <div data-collapsible-key="${key}" class="flex justify-between items-center cursor-pointer p-1 rounded hover:bg-gray-100">
                        <label class="block text-sm font-medium text-gray-600 pointer-events-none">${key}</label>
                        <span class="collapse-icon text-gray-500">${icons.chevronRight}</span>
                    </div>
                    ${renderMultiSelect(key, values)}
                </div>
            `;

            return `<aside id="sidebar" class="w-80 bg-white p-6 border-r border-gray-200 flex-col shadow-lg ${state.isSidebarOpen ? 'flex' : 'hidden'}" style="height: 100vh;"><div class="flex-grow overflow-y-auto sidebar-scroll pr-2"><h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"><span class="mr-2 text-blue-600">${icons.filter}</span>Filters</h2><div class="space-y-6"><div><h3 class="w-full flex justify-between items-center text-lg font-semibold text-gray-700 mb-2">Standard Metrics</h3><div class="space-y-2 pl-2 border-l-2 border-blue-200">${standardKeys.map(key => renderFilterGroup(key, options[key])).join('')}</div></div>${customKeys.length > 0 ? `<div><h3 class="w-full flex justify-between items-center text-lg font-semibold text-gray-700 mb-2">Custom Metrics</h3><div class="space-y-2 pl-2 border-l-2 border-green-200">${customKeys.map(key => renderFilterGroup(key, options[key])).join('')}</div></div>` : ''}</div></div><div class="flex-shrink-0 pt-4 border-t mt-4 space-y-2"><button id="deeper-analysis-btn" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors flex items-center justify-center"><span class="w-5 h-5 mr-2">${icons.search}</span>Deeper Analysis</button><button id="download-csv-btn" class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors flex items-center justify-center"><span class="w-5 h-5 mr-2">${icons.download}</span>Download Filtered</button><button id="clear-filters-btn" class="w-full py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold transition-colors">Clear All Filters</button></div></aside>`;
        }
        
        function renderHeader() {
            return `<div id="header-container" class="flex-shrink-0">${renderHeaderContent()}</div>`;
        }

        function renderHeaderContent() {
             const activeFilters = Object.entries(state.filters).filter(([key, value]) => value.length > 0);
            return `<header class="flex justify-between items-center mb-6"><div class="flex items-center"><button id="toggle-sidebar-btn" class="p-2 rounded-md hover:bg-gray-200 mr-4"><span class="w-6 h-6 text-gray-600 inline-block">${state.isSidebarOpen ? icons.x : icons.filter}</span></button><div><h1 class="text-3xl font-bold text-gray-800">Conversation Analysis</h1><div class="flex items-center text-sm text-gray-500 mt-1"><span class="w-4 h-4 mr-2 inline-block">${icons.file}</span><span>${state.fileName}</span></div></div></div><button id="reset-app-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition-colors flex items-center"><span class="w-5 h-5 mr-2 inline-block">${icons.uploadCloud}</span> Upload New File</button></header>${activeFilters.length > 0 ? `<div class="mb-4"><h3 class="text-sm font-semibold text-gray-600 mb-2">Active Filters:</h3><div class="flex flex-wrap gap-2">${activeFilters.map(([key, values]) => values.map(value => `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><strong>${key}:</strong>&nbsp;${value}</span>`).join('')).join('')}</div></div>` : ''}`;
        }

        function renderSummaryPanel() {
            return `<div id="summary-panel" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">${renderSummaryContent()}</div>`;
        }
        
        function renderSummaryContent() {
            const { timeRange, peakConcurrency, totalContained, avgHandleTime } = state.summaryStats;
            const summaryCard = (title, value) => `<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-sm font-medium text-gray-500">${title}</h3><p class="text-2xl font-bold text-gray-800 mt-1">${value}</p></div>`;
            return `
                ${summaryCard('Time Range', timeRange)}
                ${summaryCard('Total Conversations', state.data.length.toLocaleString())}
                ${summaryCard('Filtered Conversations', state.filteredData.length.toLocaleString())}
                ${summaryCard('Peak Concurrency', peakConcurrency.toLocaleString())}
                ${summaryCard('Total Contained', totalContained.toLocaleString())}
                ${summaryCard('Avg. Handle Time', avgHandleTime)}
            `;
        }
        
        function renderMainChart() {
            return `<div id="main-chart-container" class="flex flex-col h-full"><h3 class="text-center font-semibold text-gray-700">Filtered vs. Total</h3><div class="flex-grow flex items-center justify-center relative"><canvas id="main-pie-chart"></canvas><div class="absolute text-center pointer-events-none"><span id="main-chart-percentage" class="text-3xl font-bold text-blue-600"></span><p class="text-sm text-gray-500">Filtered</p></div></div></div>`;
        }

        function renderDataTable() {
            return `<div id="data-table-wrapper" class="relative overflow-auto flex-grow">${renderTableContent()}</div><div id="pagination-controls-container" class="flex-shrink-0 p-2 border-t">${renderPaginationControls()}</div>`;
        }
        
        function renderTableContent() {
            const paginatedData = getPaginatedAndSortedData();
            const displayHeaders = state.headers.filter(h => h.toLowerCase() !== 'custom metrics');
            const getSortIndicator = (key) => (state.sortConfig.key !== key) ? '' : (state.sortConfig.direction === 'ascending' ? ' ▲' : ' ▼');
            return `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50 sticky top-0 z-10"><tr>${displayHeaders.map(header => `<th data-sort-key="${header}" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer whitespace-nowrap">${header}${getSortIndicator(header)}</th>`).join('')}${state.customMetricKeys.map(key => `<th data-sort-key="${key}" class="px-6 py-3 text-left text-xs font-medium text-green-600 bg-green-50 uppercase tracking-wider cursor-pointer whitespace-nowrap">${key}${getSortIndicator(key)}</th>`).join('')}</tr></thead><tbody class="bg-white divide-y divide-gray-200">${paginatedData.length > 0 ? paginatedData.map((row) => `<tr>${displayHeaders.map(header => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${String(row[header.toLowerCase()] ?? '')}</td>`).join('')}${state.customMetricKeys.map(key => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 bg-green-50">${String(row[key.toLowerCase()] ?? '')}</td>`).join('')}</tr>`).join('') : `<tr><td colspan="${displayHeaders.length + state.customMetricKeys.length}" class="text-center py-10 text-gray-500">No conversations match the current filters.</td></tr>`}</tbody></table>`;
        }

        function renderPaginationControls() {
            const { currentPage, rowsPerPage } = state.pagination;
            const totalRows = state.filteredData.length;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const startRow = totalRows === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
            const endRow = Math.min(currentPage * rowsPerPage, totalRows);

            return `<div class="flex items-center justify-between text-sm text-gray-600">
                <div>Showing ${startRow} to ${endRow} of ${totalRows.toLocaleString()} results</div>
                <div class="flex items-center gap-2">
                    <button id="prev-page-btn" class="px-3 py-1 border rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                    <span>Page ${currentPage} of ${totalPages > 0 ? totalPages : 1}</span>
                    <button id="next-page-btn" class="px-3 py-1 border rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" ${currentPage >= totalPages ? 'disabled' : ''}>Next</button>
                </div>
            </div>`;
        }
        
        // --- LOGIC & DATA HANDLING ---
        function parseDate(dateString) {
            if (!dateString) return null;
            const cleanDateString = dateString.replace(/\[.*\]/, '');
            const date = new Date(cleanDateString);
            return isNaN(date) ? null : date;
        }
        
        function getPaginatedAndSortedData() {
            let sortableData = [...state.filteredData];
            const { key, direction } = state.sortConfig;
            if (key !== null) {
                const lowerCaseKey = key.toLowerCase();
                sortableData.sort((a, b) => {
                    const valA = a[lowerCaseKey]; const valB = b[lowerCaseKey];
                    if (valA < valB) return direction === 'ascending' ? -1 : 1;
                    if (valA > valB) return direction === 'ascending' ? 1 : -1;
                    return 0;
                });
            }
            const { currentPage, rowsPerPage } = state.pagination;
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            return sortableData.slice(start, end);
        }

        function getFilterOptions() {
            if (state.data.length === 0) return {};
            const options = {};
            const allFilterableKeys = [...new Set([...state.headers, ...state.customMetricKeys])];
            const filterableColumns = allFilterableKeys.filter(key => !['Custom Metrics', 'Conversation Id'].map(k=>k.toLowerCase()).includes(key.toLowerCase()));
            
            filterableColumns.forEach(header => {
                const uniqueValues = [...new Set(state.data.map(row => row[header.toLowerCase()]).filter(val => val != null && val !== ''))];
                if (uniqueValues.length > 0) options[header] = uniqueValues.sort();
            });
            return options;
        }

        function handleFile(file) {
            if (!file) return;
            if (file.type !== 'text/csv') {
                state.error = 'Invalid file type. Please upload a CSV file.';
                renderApp();
                return;
            }
            state.fileName = file.name; state.error = ''; state.isLoading = true;
            renderApp(); 
            fileParserWorker.postMessage({ type: 'parse', file });
        }
        
        function resetApp() {
            if (state.mainChartInstance) { state.mainChartInstance.destroy(); state.mainChartInstance = null; }
            closeConsumptionAnalysisModal();
            Object.assign(state, { data: [], filteredData: [], headers: [], customMetricKeys: [], filters: {}, fileName: '', error: '', isLoading: false, pagination: { currentPage: 1, rowsPerPage: 100 } });
            if (fileParserWorker) fileParserWorker.terminate();
            setupAndAttachWorker();
            renderApp();
        }

        function downloadFilteredCSV() {
            if (state.filteredData.length === 0) { alert("No data to download."); return; }
            const allHeaders = [...new Set([...state.headers.filter(h => h.toLowerCase() !== 'custom metrics'), ...state.customMetricKeys])];
            
            // Create a temporary data array with original header casing for export
            const exportData = state.filteredData.map(row => {
                const newRow = {};
                for (const header of allHeaders) {
                    newRow[header] = row[header.toLowerCase()];
                }
                return newRow;
            });

            const csv = Papa.unparse({ fields: allHeaders, data: exportData });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `filtered_${state.fileName}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- CHART UPDATE FUNCTIONS (OPTIMIZED) ---
        function setupMainChart() {
            const chartEl = document.getElementById('main-pie-chart');
            if (!chartEl) return;
            state.mainChartInstance = new Chart(chartEl.getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Filtered Conversations', 'Other Conversations'], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#e5e7eb'], hoverBackgroundColor: ['#2563eb', '#d1d5db'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: true } } }
            });
            updateMainChart();
        }

        function updateMainChart() {
            if (!state.mainChartInstance) return;
            const total = state.data.length; const filtered = state.filteredData.length; const others = total - filtered;
            const percentage = total > 0 ? ((filtered / total) * 100).toFixed(1) : 0;
            
            state.mainChartInstance.data.datasets[0].data = [filtered, others];
            state.mainChartInstance.update();
            document.getElementById('main-chart-percentage').textContent = `${percentage}%`;
        }
        
        // --- DEEPER ANALYSIS MODAL ---
        function transformDataForDeeperAnalysis(filteredData) {
            const dailyAggregation = {};
            const handleTimeAggregation = {};
            const containmentAggregation = {};

            const events = [];
            filteredData.forEach(row => {
                const start = parseDate(row.created);
                const end = parseDate(row.ended);
                if(start && end) {
                    events.push({ time: start.getTime(), type: 'start' });
                    events.push({ time: end.getTime(), type: 'end' });
                }

                const date = start;
                if (!date) return;
                const dateString = date.toISOString().slice(0, 10); // YYYY-MM-DD
                const handleTime = parseHandleTime(row['total handle time']);
                
                const key = `${row.domain || 'Unknown'}|${row.channel || 'Unknown'}|${dateString}`;
                if (!dailyAggregation[key]) dailyAggregation[key] = { domain: row.domain || 'Unknown', channel: row.channel || 'Unknown', date: dateString, count: 0 };
                dailyAggregation[key].count += 1;

                if (handleTime !== null) {
                    if (!handleTimeAggregation[dateString]) handleTimeAggregation[dateString] = { totalSeconds: 0, count: 0 };
                    handleTimeAggregation[dateString].totalSeconds += handleTime;
                    handleTimeAggregation[dateString].count += 1;
                }
                
                if (!containmentAggregation[dateString]) containmentAggregation[dateString] = { contained: 0, total: 0 };
                containmentAggregation[dateString].total += 1;
                if (row['amelia handled'] === 'true') {
                    containmentAggregation[dateString].contained += 1;
                }
            });
            
            events.sort((a,b) => a.time - b.time);
            let maxConcurrency = 0;
            let currentConcurrency = 0;
            for(const event of events) {
                if(event.type === 'start') {
                    currentConcurrency++;
                    if(currentConcurrency > maxConcurrency) maxConcurrency = currentConcurrency;
                } else {
                    currentConcurrency--;
                }
            }

            const handleTimeData = Object.entries(handleTimeAggregation).map(([date, data]) => ({
                date, avgMinutes: (data.totalSeconds / data.count) / 60
            })).sort((a,b) => new Date(a.date) - new Date(b.date));

            const containmentTrendData = Object.entries(containmentAggregation).map(([date, data]) => ({
                date,
                rate: data.total > 0 ? (data.contained / data.total) * 100 : 0
            })).sort((a,b) => new Date(a.date) - new Date(b.date));

            return { volumeData: Object.values(dailyAggregation), handleTimeData, containmentTrendData, peakConcurrency: maxConcurrency };
        }
        
        function parseHandleTime(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return null;
            const parts = timeStr.split(':');
            if (parts.length !== 3) return null;
            const [hours, minutes, seconds] = parts.map(Number);
            if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) return null;
            return hours * 3600 + minutes * 60 + seconds;
        }

        function renderConsumptionAnalysisModal(analysisData) {
            state.consumptionAnalysisState.originalData = analysisData.volumeData;
            const totalFiltered = state.filteredData.length;
            const totalContained = state.filteredData.filter(r => r['amelia handled'] === 'true').length;
            const overallContainmentRate = totalFiltered > 0 ? ((totalContained / totalFiltered) * 100).toFixed(1) : 0;

            const summaryCard = (title, value) => `<div class="bg-white p-3 rounded-lg text-center shadow-sm"><h4 class="text-sm font-medium text-gray-500">${title}</h4><p class="text-xl font-bold text-gray-800 mt-1">${value}</p></div>`;
            modalRoot.innerHTML = `<div id="ca-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4 opacity-0"><div id="ca-modal-container" class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col transform scale-95"><div class="p-4 border-b flex justify-between items-center flex-shrink-0"><h2 class="text-2xl font-bold text-gray-800">Deeper Analysis</h2><div class="flex items-center gap-4"><button id="ca-download-report-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Download Report</button><button id="ca-close-modal-btn" class="p-2 rounded-full hover:bg-gray-200">${icons.x}</button></div></div><div class="flex-grow p-6 overflow-y-auto"><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">${summaryCard('Filtered Conversations', totalFiltered.toLocaleString())}${summaryCard('Filtered Peak Concurrency', analysisData.peakConcurrency)}${summaryCard('Overall Containment Rate', `${overallContainmentRate}%`)}</div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="p-4 rounded-lg bg-gray-50"><h3 class="font-semibold mb-2 text-center">Containment Rate Trend</h3><div style="height: 250px;"><canvas id="ca-containment-trend-chart"></canvas></div></div><div class="p-4 rounded-lg bg-gray-50"><h3 class="font-semibold mb-2 text-center">Avg. Handle Time Trend (Minutes)</h3><div style="height: 250px;"><canvas id="ca-handle-time-chart"></canvas></div></div><div class="p-4 rounded-lg bg-gray-50"><h3 class="font-semibold mb-2 text-center">Daily Conversation Volume</h3><div style="height: 250px;"><canvas id="ca-daily-chart"></canvas></div></div><div class="p-4 rounded-lg bg-gray-50"><h3 class="font-semibold mb-2 text-center">Weekly Conversation Volume</h3><div style="height: 250px;"><canvas id="ca-weekly-chart"></canvas></div></div></div></div></div></div>`;
            
            setTimeout(() => {
                document.getElementById('ca-modal-overlay').classList.remove('opacity-0');
                document.getElementById('ca-modal-container').classList.remove('scale-95');
            }, 10);

            setupConsumptionAnalysis(analysisData);
            document.getElementById('ca-close-modal-btn').addEventListener('click', closeConsumptionAnalysisModal);
            document.getElementById('ca-download-report-btn').addEventListener('click', downloadConsumptionReport);
            document.getElementById('ca-modal-overlay').addEventListener('click', (e) => { if (e.target.id === 'ca-modal-overlay') closeConsumptionAnalysisModal(); });
        }

        function closeConsumptionAnalysisModal() {
            const overlay = document.getElementById('ca-modal-overlay');
            if (overlay) {
                 overlay.classList.add('opacity-0');
                 document.getElementById('ca-modal-container').classList.add('scale-95');
                 setTimeout(() => {
                    modalRoot.innerHTML = '';
                    Object.values(state.consumptionAnalysisState).forEach(chart => { if (chart && typeof chart.destroy === 'function') chart.destroy(); });
                    state.consumptionAnalysisState = { dailyChart: null, weeklyChart: null, containmentChart: null, handleTimeChart: null, originalData: [] };
                 }, 300);
            }
        }
        
        function setupConsumptionAnalysis(data) {
            ca_displayContainmentTrendChart(data.containmentTrendData);
            ca_displayHandleTimeChart(data.handleTimeData);
            ca_displayDailyChart(data.volumeData);
            ca_displayWeeklyChart(data.volumeData);
        }

        function ca_displayContainmentTrendChart(containmentTrendData) {
            const chartEl = document.getElementById('ca-containment-trend-chart');
            if (!chartEl) return;
            const labels = containmentTrendData.map(d => d.date);
            const data = containmentTrendData.map(d => d.rate);
            state.consumptionAnalysisState.containmentChart = new Chart(chartEl, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Containment Rate (%)', data: data, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.2 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true, max: 100, title: { display: true, text: 'Containment (%)' } } }, plugins: { legend: { display: false } } }
            });
        }

        function ca_displayHandleTimeChart(handleTimeData) {
            const chartEl = document.getElementById('ca-handle-time-chart');
            if (!chartEl) return;
            const labels = handleTimeData.map(d => d.date);
            const data = handleTimeData.map(d => d.avgMinutes);
            state.consumptionAnalysisState.handleTimeChart = new Chart(chartEl, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Avg Handle Time (min)', data: data, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.2 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true, title: { display: true, text: 'Minutes' } } }, plugins: { legend: { display: false } } }
            });
        }

        function ca_displayDailyChart(data) {
            const dailyData = {}; const datasetKeys = new Set();
            data.forEach(row => {
                const dateKey = row.date;
                const count = Number(row.count) || 0;
                const dataKey = `${row.domain || 'Unknown'} - ${row.channel || 'Unknown'}`;
                datasetKeys.add(dataKey);
                if (!dailyData[dateKey]) dailyData[dateKey] = {};
                dailyData[dateKey][dataKey] = (dailyData[dateKey][dataKey] || 0) + count;
            });
            const sortedDays = [...new Set(state.consumptionAnalysisState.originalData.map(r => r.date))].sort();
            const datasets = Array.from(datasetKeys).sort().map((key, index) => ({
                label: key, data: sortedDays.map(day => dailyData[day]?.[key] || 0),
                borderColor: ca_generateColor(index), backgroundColor: ca_generateColor(index) + '1A', fill: true, tension: 0.2
            }));
            if (state.consumptionAnalysisState.dailyChart) state.consumptionAnalysisState.dailyChart.destroy();
            state.consumptionAnalysisState.dailyChart = new Chart(document.getElementById('ca-daily-chart'), {
                type: 'line', data: { labels: sortedDays, datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } } }
            });
        }
        
        function getWeekStartDate(date) {
            const d = new Date(date + 'T00:00:00Z');
            const day = d.getUTCDay();
            const diff = d.getUTCDate() - day;
            return new Date(d.setUTCDate(diff)).toISOString().slice(0, 10);
        }

        function ca_displayWeeklyChart(data) {
            const weeklyData = {}; const datasetKeys = new Set();
            data.forEach(row => {
                const weekKey = getWeekStartDate(row.date);
                const count = Number(row.count) || 0;
                const dataKey = `${row.domain || 'Unknown'} - ${row.channel || 'Unknown'}`;
                datasetKeys.add(dataKey);
                if (!weeklyData[weekKey]) weeklyData[weekKey] = {};
                weeklyData[weekKey][dataKey] = (weeklyData[weekKey][dataKey] || 0) + count;
            });
            const sortedWeeks = [...new Set(state.consumptionAnalysisState.originalData.map(r => getWeekStartDate(r.date)))].sort();
            const datasets = Array.from(datasetKeys).sort().map((key, index) => ({
                label: key, data: sortedWeeks.map(week => weeklyData[week]?.[key] || 0),
                backgroundColor: ca_generateColor(index)
            }));
            if (state.consumptionAnalysisState.weeklyChart) state.consumptionAnalysisState.weeklyChart.destroy();
            state.consumptionAnalysisState.weeklyChart = new Chart(document.getElementById('ca-weekly-chart'), {
                type: 'bar', data: { labels: sortedWeeks, datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'week' }, stacked: true }, y: { beginAtZero: true, stacked: true } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } } }
            });
        }
        
        function ca_generateColor(index) {
            const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6', '#ec4899'];
            return colors[index % colors.length];
        }
        
        async function downloadConsumptionReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a4' });
            const addImageToPdf = async (element, doc, yPos, title) => {
                const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#ffffff' });
                const imgData = canvas.toDataURL('image/png');
                const pageWidth = doc.internal.pageSize.getWidth(); const margin = 15;
                const imgWidth = pageWidth - (margin * 2);
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                doc.setFontSize(16); doc.text(title, margin, yPos);
                doc.addImage(imgData, 'PNG', margin, yPos + 5, imgWidth, imgHeight);
                return yPos + imgHeight + 15;
            };
            doc.addPage();
            let yPos = 15;
            yPos = await addImageToPdf(document.getElementById('ca-containment-trend-chart').parentElement, doc, yPos, 'Containment Rate Trend');
            yPos = await addImageToPdf(document.getElementById('ca-handle-time-chart').parentElement, doc, yPos, 'Avg. Handle Time Trend');
            doc.addPage();
            yPos = 15;
            yPos = await addImageToPdf(document.getElementById('ca-daily-chart').parentElement, doc, yPos, 'Daily Conversation Volume');
            yPos = await addImageToPdf(document.getElementById('ca-weekly-chart').parentElement, doc, yPos, 'Weekly Conversation Volume');
            doc.deletePage(1);
            doc.save('Deeper_Analysis_Report.pdf');
        }

        // --- EVENT LISTENERS & WORKER SETUP ---

        function setupFileParserWorker() {
            const workerCode = `
                self.importScripts('https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js');
                let fullData = [];

                function applyFilters(filters) {
                    if (Object.keys(filters).length === 0 || Object.values(filters).every(arr => arr.length === 0)) {
                        return fullData;
                    }
                    return fullData.filter(row => {
                        return Object.entries(filters).every(([key, selectedValues]) => {
                            if (!selectedValues || selectedValues.length === 0) {
                                return true;
                            }
                            return selectedValues.includes(String(row[key.toLowerCase()]));
                        });
                    });
                }
                
                self.onmessage = function(e) {
                    const messageType = e.data.type;

                    if (messageType === 'parse') {
                        const file = e.data.file;
                        const standardHeaders = new Set(['conversation id', 'domain', 'created', 'ended', 'finished', 'status', 'channel', 'primary agent email', 'primary agent handle time', 'primary agent answer speed', 'pickup sla violation', 'escalated', 'escalation queue', 'escalation reason', 'abandoned', 'amelia handled', 'amelia abandoned', 'agent handled', 'agent abandoned', 'escalate abandoned', 'total handle time', 'executed bpns', 'user name', 'user email', 'user external uid', 'disconnect wait time', 'after conversation time', 'after conversation violation', 'resolution codes', 'custom metrics']);

                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                if (results.errors && results.errors.length > 0 && results.data.length === 0) {
                                    self.postMessage({ type: 'parse-error', error: results.errors[0].message });
                                    return;
                                }
                                const originalHeaders = results.meta.fields;
                                let parsedData = results.data.map(row => {
                                    const newRow = {};
                                    for (const key in row) {
                                        newRow[key.trim().toLowerCase()] = row[key];
                                    }
                                    return newRow;
                                });

                                const lowerCaseHeaders = originalHeaders.map(h => h.trim().toLowerCase());
                                const newCustomMetricKeys = new Set();
                                const isOriginalFormat = lowerCaseHeaders.includes('custom metrics');

                                if (isOriginalFormat) {
                                    parsedData = parsedData.map(row => {
                                        const customMetricsRaw = row['custom metrics'] || '';
                                        const customMetrics = {};
                                        if (customMetricsRaw) {
                                            customMetricsRaw.split('||').forEach(metric => {
                                                const [key, value] = metric.split('=');
                                                if (key) {
                                                    let trimmedKey = key.trim();
                                                    let lowerTrimmedKey = trimmedKey.toLowerCase();
                                                    
                                                    if (standardHeaders.has(lowerTrimmedKey)) {
                                                        trimmedKey = \`\${trimmedKey}_Custom\`;
                                                        lowerTrimmedKey = trimmedKey.toLowerCase();
                                                    }
                                                    row[lowerTrimmedKey] = value ? value.trim() : null;
                                                    newCustomMetricKeys.add(trimmedKey);
                                                }
                                            });
                                        }
                                        return row;
                                    });
                                } else {
                                    originalHeaders.forEach(header => { if (!standardHeaders.has(header.toLowerCase())) newCustomMetricKeys.add(header); });
                                }
                                fullData = parsedData;
                                self.postMessage({
                                    type: 'parse-success',
                                    data: fullData,
                                    headers: originalHeaders, 
                                    customMetricKeys: Array.from(newCustomMetricKeys)
                                });
                            },
                            error: (err) => {
                                self.postMessage({ type: 'parse-error', error: (err && err.message) ? err.message : 'An unknown parsing error occurred.' });
                            }
                        });
                    } else if (messageType === 'filter') {
                        const filteredData = applyFilters(e.data.filters);
                        self.postMessage({ type: 'filter-success', filteredData: filteredData });
                    }
                };
            `;
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            return new Worker(URL.createObjectURL(blob));
        }

        function setupUploaderEventListeners() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.createElement('input');
            fileInput.type = 'file'; fileInput.accept = '.csv';
            dropzone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); });
            dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('border-blue-500', 'bg-blue-50'); });
            dropzone.addEventListener('dragleave', (e) => { e.preventDefault(); dropzone.classList.remove('border-blue-500', 'bg-blue-50'); });
            dropzone.addEventListener('drop', (e) => { e.preventDefault(); dropzone.classList.remove('border-blue-500', 'bg-blue-50'); if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); });
        }

        function setupDashboardEventListeners() {
            // Use event delegation on a stable parent
            appRoot.addEventListener('click', (e) => {
                const toggleBtn = e.target.closest('#toggle-sidebar-btn');
                const resetBtn = e.target.closest('#reset-app-btn');
                const prevPageBtn = e.target.closest('#prev-page-btn');
                const nextPageBtn = e.target.closest('#next-page-btn');
                const clearFiltersBtn = e.target.closest('#clear-filters-btn');
                const downloadCsvBtn = e.target.closest('#download-csv-btn');
                const analysisBtn = e.target.closest('#deeper-analysis-btn');
                const collapsibleHeader = e.target.closest('[data-collapsible-key]');
                const tableHeader = e.target.closest('th[data-sort-key]');

                if (toggleBtn) {
                    state.isSidebarOpen = !state.isSidebarOpen; 
                    document.getElementById('sidebar').classList.toggle('hidden');
                    document.getElementById('sidebar').classList.toggle('flex');
                    toggleBtn.innerHTML = `<span class="w-6 h-6 text-gray-600 inline-block">${state.isSidebarOpen ? icons.x : icons.filter}</span>`;
                }
                if (resetBtn) resetApp();
                if (prevPageBtn) {
                    state.pagination.currentPage--;
                    updateDataTable();
                }
                if (nextPageBtn) {
                    state.pagination.currentPage++;
                    updateDataTable();
                }
                if (clearFiltersBtn) {
                    document.querySelectorAll('#sidebar input[type="checkbox"]').forEach(cb => cb.checked = false);
                    state.filters = {};
                    state.pagination.currentPage = 1;
                    fileParserWorker.postMessage({ type: 'filter', filters: state.filters });
                }
                if (downloadCsvBtn) downloadFilteredCSV();
                if (analysisBtn && !analysisBtn.disabled) {
                    const analysisData = transformDataForDeeperAnalysis(state.filteredData);
                    renderConsumptionAnalysisModal(analysisData);
                }
                if (collapsibleHeader) {
                    const container = collapsibleHeader.nextElementSibling;
                    container.classList.toggle('hidden');
                    const icon = collapsibleHeader.querySelector('.collapse-icon');
                    icon.innerHTML = container.classList.contains('hidden') ? icons.chevronRight : icons.chevronDown;
                }
                if (tableHeader) {
                    const key = tableHeader.dataset.sortKey;
                    let direction = 'ascending';
                    if(state.sortConfig.key === key && state.sortConfig.direction === 'ascending') direction = 'descending';
                    state.sortConfig = { key, direction };
                    state.pagination.currentPage = 1;
                    updateDataTable();
                }
            });

            const sidebar = document.getElementById('sidebar');
            if(sidebar) {
                 sidebar.addEventListener('change', (e) => {
                    if (e.target.matches('input[type="checkbox"]')) {
                        const key = e.target.dataset.filterKey;
                        const checkedBoxes = document.querySelectorAll(`input[data-filter-key="${key}"]:checked`);
                        state.filters[key] = Array.from(checkedBoxes).map(cb => cb.value);
                        state.pagination.currentPage = 1; 
                        fileParserWorker.postMessage({ type: 'filter', filters: state.filters });
                    }
                });
            }
            setupMainChart();
        }
        
        // --- TARGETED UPDATE FUNCTIONS ---
        function updateSummaryPanel() {
            document.getElementById('summary-panel').innerHTML = renderSummaryContent();
        }
        function updateDataTable() {
            document.getElementById('data-table-wrapper').innerHTML = renderTableContent();
            document.getElementById('pagination-controls-container').innerHTML = renderPaginationControls();
        }
        function updateHeader() {
            document.getElementById('header-container').innerHTML = renderHeaderContent();
        }
        function updateSidebarButtons() {
            const hasActiveFilters = Object.values(state.filters).some(arr => arr.length > 0);
            const btn = document.getElementById('deeper-analysis-btn');
            if (btn) {
                btn.disabled = !hasActiveFilters;
                btn.classList.toggle('opacity-50', !hasActiveFilters);
                btn.classList.toggle('cursor-not-allowed', !hasActiveFilters);
            }
        }
        
        function setupAndAttachWorker() {
            fileParserWorker = setupFileParserWorker();
            fileParserWorker.onmessage = (e) => {
                const messageType = e.data.type;
                if (messageType === 'parse-success') {
                    state.data = e.data.data;
                    state.headers = e.data.headers;
                    state.customMetricKeys = e.data.customMetricKeys;
                    
                    // Pre-calculate summary stats once
                    const dates = state.data.map(row => parseDate(row.created)).filter(d => d);
                    const minDate = dates.length > 0 ? new Date(Math.min.apply(null, dates)) : null;
                    const maxDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
                    state.summaryStats.timeRange = minDate && maxDate ? `${minDate.toLocaleDateString()} - ${maxDate.toLocaleDateString()}` : 'N/A';
                    state.summaryStats.uniqueDomains = new Set(state.data.map(r => r.domain)).size;
                    state.summaryStats.totalContained = state.data.filter(r => r['amelia handled'] === 'true').length;

                    let totalSeconds = 0;
                    let validCount = 0;
                    state.data.forEach(row => {
                        const seconds = parseHandleTime(row['total handle time']);
                        if(seconds !== null) {
                            totalSeconds += seconds;
                            validCount++;
                        }
                    });
                    const avgSeconds = validCount > 0 ? totalSeconds / validCount : 0;
                    const minutes = Math.floor(avgSeconds / 60).toString().padStart(2, '0');
                    const seconds = Math.floor(avgSeconds % 60).toString().padStart(2, '0');
                    state.summaryStats.avgHandleTime = `${minutes}:${seconds}`;

                    const events = [];
                    state.data.forEach(row => {
                        const start = parseDate(row.created);
                        const end = parseDate(row.ended);
                        if(start && end) {
                            events.push({ time: start.getTime(), type: 'start' });
                            events.push({ time: end.getTime(), type: 'end' });
                        }
                    });
                    events.sort((a,b) => a.time - b.time);
                    let maxConcurrency = 0;
                    let currentConcurrency = 0;
                    for(const event of events) {
                        if(event.type === 'start') {
                            currentConcurrency++;
                            if(currentConcurrency > maxConcurrency) {
                                maxConcurrency = currentConcurrency;
                            }
                        } else {
                            currentConcurrency--;
                        }
                    }
                    state.summaryStats.peakConcurrency = maxConcurrency;


                    state.filters = {};
                    state.isLoading = false;
                    renderApp(); 
                    fileParserWorker.postMessage({ type: 'filter', filters: state.filters });
                } else if (messageType === 'parse-error') {
                    state.isLoading = false;
                    state.error = `Failed to parse the file: ${e.data.error}`;
                    renderApp();
                } else if (messageType === 'filter-success') {
                    state.filteredData = e.data.filteredData;
                    updateUI();
                }
            };
        }

        // --- INITIALIZATION ---
        setupAndAttachWorker();
        renderApp();

    </script>
</body>
</html>
