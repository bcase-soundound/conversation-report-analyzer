<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Report Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevent body from scrolling horizontally */
        }
        /* Custom scrollbar for filter sidebar */
        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Ensure the main content area can scroll if needed, but the table has its own scroll */
        .main-content {
            height: 100vh;
            display: flex;
            flex-direction: column;
            min-width: 0; /* CRITICAL FIX: Prevents flex item from overflowing its container */
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-root"></div>
    <div id="modal-root"></div>

    <script type="module">
        // --- STATE MANAGEMENT ---
        let state = {
            data: [], // This will now hold only the current page of data
            totalFilteredRows: 0,
            headers: [],
            customMetricKeys: [],
            filterOptions: {},
            highCardinalityFields: [], // --- NEW: For text search filters ---
            summaryStats: { timeRange: 'N/A', totalRows: 0, peakConcurrency: 0, totalContained: 0, avgHandleTime: '00:00' }, // Pre-calculated stats
            filters: {},
            fileName: '',
            error: '',
            isLoading: false,
            isSidebarOpen: true,
            sortConfig: { key: null, direction: 'ascending' },
            pagination: { currentPage: 1, rowsPerPage: 100 },
            mainChartInstance: null,
            consumptionAnalysisState: { // State for the new modal
                dailyChart: null,
                weeklyChart: null,
                containmentChart: null,
                handleTimeChart: null,
            },
        };

        // --- ICONS ---
        const icons = {
            uploadCloud: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>`,
            file: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            download: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
            filter: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>`,
            search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`,
            chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`,
            chevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
        };

        const appRoot = document.getElementById('app-root');
        const modalRoot = document.getElementById('modal-root');
        let fileParserWorker;

        // --- RENDER & UPDATE FUNCTIONS ---
        
        function renderApp() {
            if (state.isLoading) {
                 appRoot.innerHTML = renderUploader();
                 return;
            }
            if (state.summaryStats.totalRows === 0) {
                appRoot.innerHTML = renderUploader();
                setupUploaderEventListeners();
            } else {
                appRoot.innerHTML = renderDashboard();
                setupMainChart();
                updateUI();
                setupDashboardEventListeners(); // Re-attach listeners after full dashboard render
            }
        }
        
        // OPTIMIZED: This function now only updates the necessary parts of the UI
        function updateUI() {
            updateSummaryPanel();
            updateMainChart();
            updateDataTable();
            updateHeader();
        }

        function renderUploader() {
            if (state.isLoading) {
                return `<div class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4 text-center"><div class="loader"></div><p class="text-lg font-semibold text-gray-700 mt-4">Processing your file...</p></div>`;
            }
            return `<div class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4 text-center"><div id="dropzone" class="w-full max-w-lg p-10 border-2 border-dashed rounded-xl cursor-pointer transition-colors border-gray-300 bg-white hover:bg-gray-100"><div class="flex flex-col items-center justify-center space-y-4 pointer-events-none"><div class="bg-blue-100 p-4 rounded-full"><span class="w-10 h-10 text-blue-600 inline-block">${icons.uploadCloud.replace('width="24"','width="40"').replace('height="24"','height="40"')}</span></div><p class="text-lg font-semibold text-gray-700">Drag & drop your CSV file here</p><p class="text-sm text-gray-500">or</p><button class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">Browse files</button><p class="text-xs text-gray-400 mt-2">Only *.csv files are accepted</p></div></div>${state.error ? `<p class="text-red-500 mt-4">${state.error}</p>` : ''}<div class="mt-8 text-left max-w-lg w-full"><h3 class="text-xl font-bold text-gray-800 mb-2">Welcome to the Conversation Analyzer</h3><p class="text-gray-600">This tool helps you process and analyze conversation reports. Simply upload your CSV file to get started.</p></div></div>`;
        }

        function renderDashboard() {
            return `<div class="min-h-screen font-sans flex">${renderSidebar()}<main class="flex-1 p-6 md:p-8 main-content">${renderHeader()}<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-shrink-0"><div class="lg:col-span-2">${renderSummaryPanel()}</div><div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">${renderMainChart()}</div></div><div class="mt-6 bg-white rounded-xl shadow-md flex-grow flex flex-col overflow-hidden">${renderDataTable()}</div></main></div>`;
        }

        function renderSidebar() {
            const options = state.filterOptions;
            const standardKeys = Object.keys(options).filter(k => !state.customMetricKeys.includes(k) && k !== 'Created' && k !== 'Finished').sort();
            const customKeys = Object.keys(options).filter(k => state.customMetricKeys.includes(k)).sort();
            
            const renderMultiSelect = (key, values) => {
                const selectedValues = state.filters[key] || [];
                const optionsHTML = values.map(val => `
                    <label class="flex items-center space-x-2 cursor-pointer p-1 rounded hover:bg-gray-100">
                        <input type="checkbox" data-filter-key="${key}" value="${val}" ${selectedValues.includes(val) ? 'checked' : ''} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-sm text-gray-700">${val}</span>
                    </label>
                `).join('');
                return `<div class="pl-2 mt-1 space-y-1 max-h-48 overflow-y-auto pr-2 hidden">${optionsHTML}</div>`;
            };

            const renderFilterGroup = (key, values) => `
                <div class="metric-filter-group">
                    <div data-collapsible-key="${key}" class="flex justify-between items-center cursor-pointer p-1 rounded hover:bg-gray-100">
                        <label class="block text-sm font-medium text-gray-600 pointer-events-none">${key}</label>
                        <span class="collapse-icon text-gray-500">${icons.chevronRight}</span>
                    </div>
                    ${renderMultiSelect(key, values)}
                </div>
            `;
            
            const renderDateRangeFilter = () => `
                <div>
                    <h3 class="w-full flex justify-between items-center text-lg font-semibold text-gray-700 mb-2">Date Range</h3>
                    <div class="space-y-2 pl-2 border-l-2 border-purple-200 p-2">
                        <div>
                            <label for="start-date" class="block text-sm font-medium text-gray-600">Start Date</label>
                            <input type="date" id="start-date" name="start-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="end-date" class="block text-sm font-medium text-gray-600">End Date</label>
                            <input type="date" id="end-date" name="end-date" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>
                </div>
            `;

            const renderTextSearchFilter = (key) => `
                <div class="metric-filter-group">
                    <label for="text-filter-${key}" class="block text-sm font-medium text-gray-600">${key}</label>
                    <input type="text" id="text-filter-${key}" data-filter-key="${key}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Contains...">
                </div>
            `;

            return `<aside id="sidebar" class="w-80 bg-white p-6 border-r border-gray-200 flex-col shadow-lg ${state.isSidebarOpen ? 'flex' : 'hidden'}" style="height: 100vh;"><div class="flex-grow overflow-y-auto sidebar-scroll pr-2"><h2 class="text-2xl font-bold text-gray-800 mb-2 flex items-center"><span class="mr-2 text-blue-600">${icons.filter}</span>Filters</h2><div class="relative mb-4"><input type="search" id="metric-search-input" placeholder="Search metrics..." class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"><div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">${icons.search.replace('width="24"','width="20"').replace('height="24"','height="20"').replace('stroke="currentColor"','stroke="gray"')}</div></div><div class="space-y-6">${renderDateRangeFilter()}<div><h3 class="w-full flex justify-between items-center text-lg font-semibold text-gray-700 mb-2">Standard Metrics</h3><div class="space-y-2 pl-2 border-l-2 border-blue-200">${standardKeys.map(key => renderFilterGroup(key, options[key])).join('')}</div></div>${customKeys.length > 0 ? `<div><h3 class="w-full flex justify-between items-center text-lg font-semibold text-gray-700 mb-2">Custom Metrics</h3><div class="space-y-2 pl-2 border-l-2 border-green-200">${customKeys.map(key => renderFilterGroup(key, options[key])).join('')}</div></div>` : ''}${state.highCardinalityFields.length > 0 ? `<div><h3 class="w-full flex justify-between items-center text-lg font-semibold text-gray-700 mb-2">Text Search Filters</h3><p class="text-xs text-gray-500 pl-2 mb-2">For metrics with 200+ unique values.</p><div class="space-y-4 pl-2 border-l-2 border-yellow-200 p-2">${state.highCardinalityFields.map(key => renderTextSearchFilter(key)).join('')}</div></div>` : ''}</div></div><div class="flex-shrink-0 pt-4 border-t mt-4 space-y-2"><button id="deeper-analysis-btn" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors flex items-center justify-center"><span class="w-5 h-5 mr-2">${icons.search}</span>Deeper Analysis</button><button id="download-csv-btn" class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors flex items-center justify-center"><span class="w-5 h-5 mr-2">${icons.download}</span>Download Filtered</button><button id="clear-filters-btn" class="w-full py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold transition-colors">Clear All Filters</button></div></aside>`;
        }
        
        function renderHeader() {
            return `<div id="header-container" class="flex-shrink-0">${renderHeaderContent()}</div>`;
        }

        function renderHeaderContent() {
            const activeFilters = Object.entries(state.filters);
            let activeFilterHTML = '';

            activeFilters.forEach(([key, value]) => {
                if (key === 'dateRange') {
                    if (value.start || value.end) {
                        activeFilterHTML += `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800"><strong>Date:</strong>&nbsp;${value.start || '...'} to ${value.end || '...'}</span>`;
                    }
                } else if (Array.isArray(value) && value.length > 0) {
                    activeFilterHTML += value.map(val => `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"><strong>${key}:</strong>&nbsp;${val}</span>`).join('');
                } else if (typeof value === 'string' && value.length > 0) {
                    activeFilterHTML += `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><strong>${key} contains:</strong>&nbsp;${value}</span>`;
                }
            });

            return `<header class="flex justify-between items-center mb-6"><div class="flex items-center"><button id="toggle-sidebar-btn" class="p-2 rounded-md hover:bg-gray-200 mr-4"><span class="w-6 h-6 text-gray-600 inline-block">${state.isSidebarOpen ? icons.x : icons.filter}</span></button><div><h1 class="text-3xl font-bold text-gray-800">Conversation Analysis</h1><div class="flex items-center text-sm text-gray-500 mt-1"><span class="w-4 h-4 mr-2 inline-block">${icons.file}</span><span>${state.fileName}</span></div></div></div><button id="reset-app-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition-colors flex items-center"><span class="w-5 h-5 mr-2 inline-block">${icons.uploadCloud}</span> Upload New File</button></header>${activeFilterHTML ? `<div class="mb-4"><h3 class="text-sm font-semibold text-gray-600 mb-2">Active Filters:</h3><div class="flex flex-wrap gap-2">${activeFilterHTML}</div></div>` : ''}`;
        }

        function renderSummaryPanel() {
            return `<div id="summary-panel" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">${renderSummaryContent()}</div>`;
        }
        
        function renderSummaryContent() {
            const { timeRange, peakConcurrency, totalContained, avgHandleTime, totalRows } = state.summaryStats;
            const summaryCard = (title, value) => `<div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200"><h3 class="text-sm font-medium text-gray-500">${title}</h3><p class="text-2xl font-bold text-gray-800 mt-1">${value}</p></div>`;
            return `
                ${summaryCard('Time Range', timeRange)}
                ${summaryCard('Total Conversations', totalRows.toLocaleString())}
                ${summaryCard('Filtered Conversations', state.totalFilteredRows.toLocaleString())}
                ${summaryCard('Peak Concurrency', peakConcurrency.toLocaleString())}
                ${summaryCard('Total Contained', totalContained.toLocaleString())}
                ${summaryCard('Avg. Handle Time', avgHandleTime)}
            `;
        }
        
        function renderMainChart() {
            return `<div id="main-chart-container" class="flex flex-col h-full"><h3 class="text-center font-semibold text-gray-700">Filtered vs. Total</h3><div class="flex-grow flex items-center justify-center relative"><canvas id="main-pie-chart"></canvas><div class="absolute text-center pointer-events-none"><span id="main-chart-percentage" class="text-3xl font-bold text-blue-600"></span><p class="text-sm text-gray-500">Filtered</p></div></div></div>`;
        }

        function renderDataTable() {
            return `<div id="data-table-wrapper" class="relative overflow-auto flex-grow">${renderTableContent()}</div><div id="pagination-controls-container" class="flex-shrink-0 p-2 border-t">${renderPaginationControls()}</div>`;
        }
        
        function renderTableContent() {
            const displayHeaders = state.headers.filter(h => h.toLowerCase() !== 'custom metrics');
            const getSortIndicator = (key) => (state.sortConfig.key !== key) ? '' : (state.sortConfig.direction === 'ascending' ? ' ▲' : ' ▼');
            return `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50 sticky top-0 z-10"><tr>${displayHeaders.map(header => `<th data-sort-key="${header}" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer whitespace-nowrap">${header}${getSortIndicator(header)}</th>`).join('')}${state.customMetricKeys.map(key => `<th data-sort-key="${key}" class="px-6 py-3 text-left text-xs font-medium text-green-600 bg-green-50 uppercase tracking-wider cursor-pointer whitespace-nowrap">${key}${getSortIndicator(key)}</th>`).join('')}</tr></thead><tbody class="bg-white divide-y divide-gray-200">${state.data.length > 0 ? state.data.map((row) => `<tr>${displayHeaders.map(header => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${String(row[header.toLowerCase()] ?? '')}</td>`).join('')}${state.customMetricKeys.map(key => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 bg-green-50">${String(row[key.toLowerCase()] ?? '')}</td>`).join('')}</tr>`).join('') : `<tr><td colspan="${displayHeaders.length + state.customMetricKeys.length}" class="text-center py-10 text-gray-500">No conversations match the current filters.</td></tr>`}</tbody></table>`;
        }

        function renderPaginationControls() {
            const { currentPage, rowsPerPage } = state.pagination;
            const totalRows = state.totalFilteredRows;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const startRow = totalRows === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
            const endRow = Math.min(currentPage * rowsPerPage, totalRows);

            return `<div class="flex items-center justify-between text-sm text-gray-600">
                <div>Showing ${startRow} to ${endRow} of ${totalRows.toLocaleString()} results</div>
                <div class="flex items-center gap-2">
                    <button id="prev-page-btn" class="px-3 py-1 border rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
                    <span>Page ${currentPage} of ${totalPages > 0 ? totalPages : 1}</span>
                    <button id="next-page-btn" class="px-3 py-1 border rounded-md hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed" ${currentPage >= totalPages ? 'disabled' : ''}>Next</button>
                </div>
            </div>`;
        }
        
        // --- LOGIC & DATA HANDLING ---
        function handleFile(file) {
            if (!file) return;
            if (file.type !== 'text/csv') {
                state.error = 'Invalid file type. Please upload a CSV file.';
                renderApp();
                return;
            }
            state.fileName = file.name; state.error = ''; state.isLoading = true;
            renderApp(); 
            fileParserWorker.postMessage({ type: 'parse', file });
        }
        
        function resetApp() {
            if (state.mainChartInstance) { state.mainChartInstance.destroy(); state.mainChartInstance = null; }
            closeConsumptionAnalysisModal();
            Object.assign(state, { data: [], totalFilteredRows: 0, headers: [], customMetricKeys: [], filterOptions: {}, highCardinalityFields: [], filters: {}, fileName: '', error: '', isLoading: false, pagination: { currentPage: 1, rowsPerPage: 100 }, summaryStats: { totalRows: 0 } });
            if (fileParserWorker) fileParserWorker.terminate();
            setupAndAttachWorker();
            renderApp();
        }

        async function downloadFilteredCSV() {
            if (state.totalFilteredRows === 0) { alert("No data to download."); return; }
            // Tell the worker to start streaming the filtered data back
            fileParserWorker.postMessage({ type: 'request-csv-string' });
            // The result will be handled by the 'csv-string-data' message listener
        }

        // --- CHART UPDATE FUNCTIONS (OPTIMIZED) ---
        function setupMainChart() {
            const chartEl = document.getElementById('main-pie-chart');
            if (!chartEl) return;
            state.mainChartInstance = new Chart(chartEl.getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Filtered Conversations', 'Other Conversations'], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#e5e7eb'], hoverBackgroundColor: ['#2563eb', '#d1d5db'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false }, tooltip: { enabled: true } } }
            });
        }

        function updateMainChart() {
            if (!state.mainChartInstance) return;
            const total = state.summaryStats.totalRows; const filtered = state.totalFilteredRows; const others = total - filtered;
            const percentage = total > 0 ? ((filtered / total) * 100).toFixed(1) : 0;
            
            state.mainChartInstance.data.datasets[0].data = [filtered, others];
            state.mainChartInstance.update();
            document.getElementById('main-chart-percentage').textContent = `${percentage}%`;
        }
        
        // --- DEEPER ANALYSIS MODAL ---
        function openDeeperAnalysis() {
            const btn = document.getElementById('deeper-analysis-btn');
            if(btn) {
                btn.disabled = true;
                btn.innerHTML = `<div class="loader !w-5 !h-5 !border-2 !border-t-blue-400 mr-2"></div>Analyzing...`;
            }
            const hasActiveFilters = Object.keys(state.filters).length > 0 && Object.values(state.filters).some(value => {
                if (Array.isArray(value)) return value.length > 0;
                if (typeof value === 'object' && value !== null) return value.start || value.end;
                return false;
            });
            fileParserWorker.postMessage({ type: 'request-analysis', useFilteredData: hasActiveFilters });
        }

        // This function now receives the pre-aggregated data from the worker
        function renderConsumptionAnalysisModal(analysisData) {
            state.consumptionAnalysisState.originalData = analysisData.volumeData;
            const { filteredConversations, filteredPeakConcurrency, overallContainmentRate } = analysisData.summary;

            const summaryCard = (title, value) => `<div class="bg-white p-3 rounded-lg text-center shadow-sm"><h4 class="text-sm font-medium text-gray-500">${title}</h4><p class="text-xl font-bold text-gray-800 mt-1">${value}</p></div>`;
            modalRoot.innerHTML = `<div id="ca-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4 opacity-0"><div id="ca-modal-container" class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col transform scale-95"><div class="p-4 border-b flex justify-between items-center flex-shrink-0"><h2 class="text-2xl font-bold text-gray-800">Deeper Analysis</h2><div class="flex items-center gap-4"><button id="ca-download-report-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700">Download Report</button><button id="ca-close-modal-btn" class="p-2 rounded-full hover:bg-gray-200">${icons.x}</button></div></div><div class="flex-grow p-6 overflow-y-auto"><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">${summaryCard('Filtered Conversations', filteredConversations.toLocaleString())}${summaryCard('Filtered Peak Concurrency', filteredPeakConcurrency)}${summaryCard('Overall Containment Rate', `${overallContainmentRate}%`)}</div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div class="p-4 rounded-lg bg-gray-50"><h3 class="font-semibold mb-2 text-center">Containment Rate Trend</h3><div style="height: 250px;"><canvas id="ca-containment-trend-chart"></canvas></div></div><div class="p-4 rounded-lg bg-gray-50"><h3 class="font-semibold mb-2 text-center">Avg. Handle Time Trend (Minutes)</h3><div style="height: 250px;"><canvas id="ca-handle-time-chart"></canvas></div></div><div class="p-4 rounded-lg bg-gray-50"><h3 class="font-semibold mb-2 text-center">Daily Conversation Volume</h3><div style="height: 250px;"><canvas id="ca-daily-chart"></canvas></div></div><div class="p-4 rounded-lg bg-gray-50"><h3 class="font-semibold mb-2 text-center">Weekly Conversation Volume</h3><div style="height: 250px;"><canvas id="ca-weekly-chart"></canvas></div></div></div></div></div></div>`;
            
            setTimeout(() => {
                document.getElementById('ca-modal-overlay').classList.remove('opacity-0');
                document.getElementById('ca-modal-container').classList.remove('scale-95');
            }, 10);

            setupConsumptionAnalysis(analysisData);
            document.getElementById('ca-close-modal-btn').addEventListener('click', closeConsumptionAnalysisModal);
            document.getElementById('ca-download-report-btn').addEventListener('click', downloadConsumptionReport);
            document.getElementById('ca-modal-overlay').addEventListener('click', (e) => { if (e.target.id === 'ca-modal-overlay') closeConsumptionAnalysisModal(); });
            
            const btn = document.getElementById('deeper-analysis-btn');
            if(btn) {
                 btn.disabled = false; // Re-enable the button
                 btn.innerHTML = `<span class="w-5 h-5 mr-2">${icons.search}</span>Deeper Analysis`;
            }
        }

        function closeConsumptionAnalysisModal() {
            const overlay = document.getElementById('ca-modal-overlay');
            if (overlay) {
                 overlay.classList.add('opacity-0');
                 document.getElementById('ca-modal-container').classList.add('scale-95');
                 setTimeout(() => {
                    modalRoot.innerHTML = '';
                    Object.values(state.consumptionAnalysisState).forEach(chart => { if (chart && typeof chart.destroy === 'function') chart.destroy(); });
                    state.consumptionAnalysisState = { dailyChart: null, weeklyChart: null, containmentChart: null, handleTimeChart: null, originalData: [] };
                 }, 300);
            }
        }
        
        function setupConsumptionAnalysis(data) {
            ca_displayContainmentTrendChart(data.containmentTrendData);
            ca_displayHandleTimeChart(data.handleTimeData);
            ca_displayDailyChart(data.volumeData);
            ca_displayWeeklyChart(data.volumeData);
        }

        function ca_displayContainmentTrendChart(containmentTrendData) {
            const chartEl = document.getElementById('ca-containment-trend-chart');
            if (!chartEl) return;
            const labels = containmentTrendData.map(d => d.date);
            const data = containmentTrendData.map(d => d.rate);
            state.consumptionAnalysisState.containmentChart = new Chart(chartEl, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Containment Rate (%)', data: data, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.2 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true, max: 100, title: { display: true, text: 'Containment (%)' } } }, plugins: { legend: { display: false } } }
            });
        }

        function ca_displayHandleTimeChart(handleTimeData) {
            const chartEl = document.getElementById('ca-handle-time-chart');
            if (!chartEl) return;
            const labels = handleTimeData.map(d => d.date);
            const data = handleTimeData.map(d => d.avgMinutes);
            state.consumptionAnalysisState.handleTimeChart = new Chart(chartEl, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Avg Handle Time (min)', data: data, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true, tension: 0.2 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true, title: { display: true, text: 'Minutes' } } }, plugins: { legend: { display: false } } }
            });
        }

        function ca_displayDailyChart(data) {
            const dailyData = {}; const datasetKeys = new Set();
            data.forEach(row => {
                const dateKey = row.date;
                const count = Number(row.count) || 0;
                const dataKey = `${row.domain || 'Unknown'} - ${row.channel || 'Unknown'}`;
                datasetKeys.add(dataKey);
                if (!dailyData[dateKey]) dailyData[dateKey] = {};
                dailyData[dateKey][dataKey] = (dailyData[dateKey][dataKey] || 0) + count;
            });
            const sortedDays = [...new Set(state.consumptionAnalysisState.originalData.map(r => r.date))].sort();
            const datasets = Array.from(datasetKeys).sort().map((key, index) => ({
                label: key, data: sortedDays.map(day => dailyData[day]?.[key] || 0),
                borderColor: ca_generateColor(index), backgroundColor: ca_generateColor(index) + '1A', fill: true, tension: 0.2
            }));
            if (state.consumptionAnalysisState.dailyChart) state.consumptionAnalysisState.dailyChart.destroy();
            state.consumptionAnalysisState.dailyChart = new Chart(document.getElementById('ca-daily-chart'), {
                type: 'line', data: { labels: sortedDays, datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day' } }, y: { beginAtZero: true } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } } }
            });
        }
        
        function getWeekStartDate(date) {
            const d = new Date(date + 'T00:00:00Z');
            const day = d.getUTCDay();
            const diff = d.getUTCDate() - day;
            return new Date(d.setUTCDate(diff)).toISOString().slice(0, 10);
        }

        function ca_displayWeeklyChart(data) {
            const weeklyData = {}; const datasetKeys = new Set();
            data.forEach(row => {
                const weekKey = getWeekStartDate(row.date);
                const count = Number(row.count) || 0;
                const dataKey = `${row.domain || 'Unknown'} - ${row.channel || 'Unknown'}`;
                datasetKeys.add(dataKey);
                if (!weeklyData[weekKey]) weeklyData[weekKey] = {};
                weeklyData[weekKey][dataKey] = (weeklyData[weekKey][dataKey] || 0) + count;
            });
            const sortedWeeks = [...new Set(state.consumptionAnalysisState.originalData.map(r => getWeekStartDate(r.date)))].sort();
            const datasets = Array.from(datasetKeys).sort().map((key, index) => ({
                label: key, data: sortedWeeks.map(week => weeklyData[week]?.[key] || 0),
                backgroundColor: ca_generateColor(index)
            }));
            if (state.consumptionAnalysisState.weeklyChart) state.consumptionAnalysisState.weeklyChart.destroy();
            state.consumptionAnalysisState.weeklyChart = new Chart(document.getElementById('ca-weekly-chart'), {
                type: 'bar', data: { labels: sortedWeeks, datasets },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'week' }, stacked: true }, y: { beginAtZero: true, stacked: true } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } } }
            });
        }
        
        function ca_generateColor(index) {
            const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#3b82f6', '#8b5cf6', '#ec4899'];
            return colors[index % colors.length];
        }
        
        async function downloadConsumptionReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a4' });
            const addImageToPdf = async (element, doc, yPos, title) => {
                const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#ffffff' });
                const imgData = canvas.toDataURL('image/png');
                const pageWidth = doc.internal.pageSize.getWidth(); const margin = 15;
                const imgWidth = pageWidth - (margin * 2);
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                doc.setFontSize(16); doc.text(title, margin, yPos);
                doc.addImage(imgData, 'PNG', margin, yPos + 5, imgWidth, imgHeight);
                return yPos + imgHeight + 15;
            };
            doc.addPage();
            let yPos = 15;
            yPos = await addImageToPdf(document.getElementById('ca-containment-trend-chart').parentElement, doc, yPos, 'Containment Rate Trend');
            yPos = await addImageToPdf(document.getElementById('ca-handle-time-chart').parentElement, doc, yPos, 'Avg. Handle Time Trend');
            doc.addPage();
            yPos = 15;
            yPos = await addImageToPdf(document.getElementById('ca-daily-chart').parentElement, doc, yPos, 'Daily Conversation Volume');
            yPos = await addImageToPdf(document.getElementById('ca-weekly-chart').parentElement, doc, yPos, 'Weekly Conversation Volume');
            doc.deletePage(1);
            doc.save('Deeper_Analysis_Report.pdf');
        }

        // --- EVENT LISTENERS & WORKER SETUP ---

        function setupFileParserWorker() {
            const workerCode = `
                self.importScripts('https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js');
                let fullData = [];
                let filteredData = []; // This will always hold the currently filtered dataset
                let headers = [];
                let customMetricKeys = [];
                let filterOptions = {};
                let highCardinalityFields = [];

                // --- UTILITY FUNCTIONS (MOVED INTO WORKER) ---
                function parseDate(dateString) {
                    if (!dateString) return null;
                    // --- FIX: Robust, timezone-agnostic date parsing ---
                    const match = dateString.match(/(\\d{4})-(\\d{2})-(\\d{2})[T ](\\d{2}):(\\d{2})/);
                    if (!match) return null;
                    // Creates a date using UTC values to avoid timezone shifts
                    const date = new Date(Date.UTC(match[1], match[2] - 1, match[3], match[4], match[5]));
                    return isNaN(date) ? null : date;
                }

                function parseHandleTime(timeStr) {
                    if (!timeStr || typeof timeStr !== 'string') return null;
                    const parts = timeStr.split(':');
                    if (parts.length !== 3) return null;
                    const [hours, minutes, seconds] = parts.map(Number);
                    if (isNaN(hours) || isNaN(minutes) || isNaN(seconds)) return null;
                    return hours * 3600 + minutes * 60 + seconds;
                }
                
                function applyFilters(filters) {
                    let dataToFilter = [...fullData];

                    if (filters.dateRange && (filters.dateRange.start || filters.dateRange.end)) {
                        const startDate = filters.dateRange.start ? new Date(filters.dateRange.start + 'T00:00:00Z') : null;
                        const endDate = filters.dateRange.end ? new Date(filters.dateRange.end + 'T23:59:59Z') : null;

                        dataToFilter = dataToFilter.filter(row => {
                            const rowDate = parseDate(row.created);
                            if (!rowDate) return false;
                            if (startDate && rowDate < startDate) return false;
                            if (endDate && rowDate > endDate) return false;
                            return true;
                        });
                    }

                    const otherFilters = { ...filters };
                    delete otherFilters.dateRange;

                    return dataToFilter.filter(row => {
                        return Object.entries(otherFilters).every(([key, value]) => {
                            if (!value) return true;
                            const rowValue = String(row[key.toLowerCase()] ?? '').toLowerCase();
                            if (Array.isArray(value)) {
                                if (value.length === 0) return true;
                                return value.includes(String(row[key.toLowerCase()]));
                            } else if (typeof value === 'string') {
                                return rowValue.includes(value.toLowerCase());
                            }
                            return true;
                        });
                    });
                }

                // --- NEW: Function to calculate summary stats on filtered data ---
                function calculateFilteredSummary(data) {
                    const summary = {};
                    const dates = data.map(row => parseDate(row.created)).filter(d => d);
                    
                    let minDate = null;
                    let maxDate = null;
                    if (dates.length > 0) {
                        minDate = dates[0];
                        maxDate = dates[0];
                        for (let i = 1; i < dates.length; i++) {
                            if (dates[i] < minDate) minDate = dates[i];
                            if (dates[i] > maxDate) maxDate = dates[i];
                        }
                    }

                    summary.timeRange = minDate && maxDate ? \`\${minDate.toLocaleDateString()} - \${maxDate.toLocaleDateString()}\` : 'N/A';

                    const events = [];
                    data.forEach(row => {
                        const start = parseDate(row.created);
                        const end = parseDate(row.finished); 
                        if (start && end) {
                            events.push({ time: start.getTime(), type: 'start' });
                            events.push({ time: end.getTime(), type: 'end' });
                        }
                    });
                    events.sort((a, b) => a.time - b.time);
                    let maxConcurrency = 0, currentConcurrency = 0;
                    for (const event of events) {
                        if (event.type === 'start') {
                            currentConcurrency++;
                            if (currentConcurrency > maxConcurrency) maxConcurrency = currentConcurrency;
                        } else {
                            currentConcurrency--;
                        }
                    }
                    summary.peakConcurrency = maxConcurrency;
                    return summary;
                }
                
                self.onmessage = function(e) {
                    const messageType = e.data.type;

                    if (messageType === 'parse') {
                        const file = e.data.file;
                        const standardHeaders = new Set(['conversation id', 'domain', 'created', 'ended', 'finished', 'status', 'channel', 'primary agent email', 'primary agent handle time', 'primary agent answer speed', 'pickup sla violation', 'escalated', 'escalation queue', 'escalation reason', 'abandoned', 'amelia handled', 'amelia abandoned', 'agent handled', 'agent abandoned', 'escalate abandoned', 'total handle time', 'executed bpns', 'user name', 'user email', 'user external uid', 'disconnect wait time', 'after conversation time', 'after conversation violation', 'resolution codes', 'custom metrics']);

                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                if (results.errors && results.errors.length > 0 && results.data.length === 0) {
                                    self.postMessage({ type: 'parse-error', error: results.errors[0].message });
                                    return;
                                }
                                headers = results.meta.fields;
                                let parsedData = results.data.map(row => {
                                    const newRow = {};
                                    for (const key in row) {
                                        newRow[key.trim().toLowerCase()] = row[key];
                                    }
                                    return newRow;
                                });

                                const lowerCaseHeaders = headers.map(h => h.trim().toLowerCase());
                                const newCustomMetricKeys = new Set();
                                const isOriginalFormat = lowerCaseHeaders.includes('custom metrics');

                                if (isOriginalFormat) {
                                    parsedData = parsedData.map(row => {
                                        const customMetricsRaw = row['custom metrics'] || '';
                                        if (customMetricsRaw) {
                                            customMetricsRaw.split('||').forEach(metric => {
                                                const [key, value] = metric.split('=');
                                                if (key) {
                                                    let trimmedKey = key.trim();
                                                    let lowerTrimmedKey = trimmedKey.toLowerCase();
                                                    
                                                    if (standardHeaders.has(lowerTrimmedKey)) {
                                                        trimmedKey = \`\${trimmedKey}_Custom\`;
                                                        lowerTrimmedKey = trimmedKey.toLowerCase();
                                                    }
                                                    row[lowerTrimmedKey] = value ? value.trim() : null;
                                                    newCustomMetricKeys.add(trimmedKey);
                                                }
                                            });
                                        }
                                        return row;
                                    });
                                } else {
                                    headers.forEach(header => { if (!standardHeaders.has(header.toLowerCase())) newCustomMetricKeys.add(header); });
                                }
                                fullData = parsedData;
                                customMetricKeys = Array.from(newCustomMetricKeys);
                                
                                const allFilterableKeys = [...new Set([...headers, ...customMetricKeys])];
                                const filterableColumns = allFilterableKeys.filter(key => !['Custom Metrics', 'Conversation Id'].map(k=>k.toLowerCase()).includes(key.toLowerCase()));
                                filterOptions = {};
                                highCardinalityFields = [];
                                const MAX_FILTER_OPTIONS = 200; 
                                filterableColumns.forEach(header => {
                                    const uniqueValues = [...new Set(fullData.map(row => row[header.toLowerCase()]).filter(val => val != null && val !== ''))];
                                    if (uniqueValues.length > 0 && uniqueValues.length <= MAX_FILTER_OPTIONS) {
                                        filterOptions[header] = uniqueValues.sort();
                                    } else if (uniqueValues.length > MAX_FILTER_OPTIONS) {
                                        highCardinalityFields.push(header);
                                    }
                                });

                                const summaryStats = calculateFilteredSummary(fullData); // Use the new function for initial stats
                                summaryStats.totalRows = fullData.length;
                                summaryStats.totalContained = fullData.filter(r => r['amelia handled'] === 'true').length;

                                let totalSeconds = 0, validCount = 0;
                                fullData.forEach(row => {
                                    const seconds = parseHandleTime(row['total handle time']);
                                    if(seconds !== null) { totalSeconds += seconds; validCount++; }
                                });
                                const avgSeconds = validCount > 0 ? totalSeconds / validCount : 0;
                                summaryStats.avgHandleTime = \`\${Math.floor(avgSeconds / 60).toString().padStart(2, '0')}:\${Math.floor(avgSeconds % 60).toString().padStart(2, '0')}\`;
                                
                                self.postMessage({
                                    type: 'parse-success',
                                    headers: headers, 
                                    customMetricKeys: customMetricKeys,
                                    filterOptions: filterOptions,
                                    highCardinalityFields: highCardinalityFields,
                                    summaryStats: summaryStats
                                });
                            },
                            error: (err) => {
                                self.postMessage({ type: 'parse-error', error: (err && err.message) ? err.message : 'An unknown parsing error occurred.' });
                            }
                        });
                    } else if (messageType === 'request-page') {
                        filteredData = applyFilters(e.data.filters); 
                        const filteredSummary = calculateFilteredSummary(filteredData); // Recalculate stats on every filter change
                        const { pagination, sortConfig } = e.data; 
                        const { currentPage, rowsPerPage } = pagination;
                        
                        let dataForPaging = [...filteredData];

                        if (sortConfig && sortConfig.key) {
                            const lowerCaseKey = sortConfig.key.toLowerCase();
                            dataForPaging.sort((a, b) => {
                                const valA = a[lowerCaseKey]; 
                                const valB = b[lowerCaseKey];
                                if (valA < valB) return sortConfig.direction === 'ascending' ? -1 : 1;
                                if (valA > valB) return sortConfig.direction === 'ascending' ? 1 : -1;
                                return 0;
                            });
                        }

                        const start = (currentPage - 1) * rowsPerPage;
                        const end = start + rowsPerPage;
                        const pageData = dataForPaging.slice(start, end);

                        self.postMessage({ 
                            type: 'page-data', 
                            data: pageData, 
                            totalFilteredRows: filteredData.length,
                            filteredSummary: filteredSummary // Send updated stats back
                        });
                    } else if (messageType === 'request-csv-string') {
                        const allHeaders = [...new Set([...headers.filter(h => h.toLowerCase() !== 'custom metrics'), ...customMetricKeys])];
                        const exportData = filteredData.map(row => {
                            const newRow = {};
                            for (const header of allHeaders) { newRow[header] = row[header.toLowerCase()]; }
                            return newRow;
                        });
                        const csv = Papa.unparse({ fields: allHeaders, data: exportData });
                        self.postMessage({ type: 'csv-string-data', csvString: csv });
                    
                    } else if (messageType === 'request-analysis') {
                        const dataToAnalyze = e.data.useFilteredData ? filteredData : fullData;
                        const dailyAggregation = {}, handleTimeAggregation = {}, containmentAggregation = {};
                        const events = [];

                        dataToAnalyze.forEach(row => {
                            const start = parseDate(row.created);
                            const end = parseDate(row.finished); // --- FIX: Use 'finished' column ---
                            if(start && end) {
                                events.push({ time: start.getTime(), type: 'start' });
                                events.push({ time: end.getTime(), type: 'end' });
                            }
                            if (!start) return;

                            const dateString = start.toISOString().slice(0, 10);
                            const handleTime = parseHandleTime(row['total handle time']);
                            const key = \`\${row.domain || 'Unknown'}|\${row.channel || 'Unknown'}|\${dateString}\`;

                            if (!dailyAggregation[key]) dailyAggregation[key] = { domain: row.domain || 'Unknown', channel: row.channel || 'Unknown', date: dateString, count: 0 };
                            dailyAggregation[key].count++;

                            if (handleTime !== null) {
                                if (!handleTimeAggregation[dateString]) handleTimeAggregation[dateString] = { totalSeconds: 0, count: 0 };
                                handleTimeAggregation[dateString].totalSeconds += handleTime;
                                handleTimeAggregation[dateString].count++;
                            }
                            
                            if (!containmentAggregation[dateString]) containmentAggregation[dateString] = { contained: 0, total: 0 };
                            containmentAggregation[dateString].total++;
                            if (row['amelia handled'] === 'true') containmentAggregation[dateString].contained++;
                        });
                        
                        events.sort((a,b) => a.time - b.time);
                        let maxConcurrency = 0, currentConcurrency = 0;
                        for(const event of events) {
                            if(event.type === 'start') {
                                currentConcurrency++;
                                if(currentConcurrency > maxConcurrency) maxConcurrency = currentConcurrency;
                            } else {
                                currentConcurrency--;
                            }
                        }

                        const handleTimeData = Object.entries(handleTimeAggregation).map(([date, data]) => ({ date, avgMinutes: (data.totalSeconds / data.count) / 60 })).sort((a,b) => new Date(a.date) - new Date(b.date));
                        const containmentTrendData = Object.entries(containmentAggregation).map(([date, data]) => ({ date, rate: data.total > 0 ? (data.contained / data.total) * 100 : 0 })).sort((a,b) => new Date(a.date) - new Date(b.date));
                        
                        const totalContainedInFiltered = dataToAnalyze.filter(r => r['amelia handled'] === 'true').length;

                        self.postMessage({
                            type: 'analysis-result',
                            data: {
                                volumeData: Object.values(dailyAggregation),
                                handleTimeData,
                                containmentTrendData,
                                summary: {
                                    filteredPeakConcurrency: maxConcurrency,
                                    filteredConversations: dataToAnalyze.length,
                                    overallContainmentRate: dataToAnalyze.length > 0 ? ((totalContainedInFiltered / dataToAnalyze.length) * 100).toFixed(1) : 0
                                }
                            }
                        });
                    }
                };
            `;
            const blob = new Blob([workerCode], { type: 'application/javascript' });
            return new Worker(URL.createObjectURL(blob));
        }

        function setupUploaderEventListeners() {
            const dropzone = document.getElementById('dropzone');
            if(!dropzone) return;
            const fileInput = document.createElement('input');
            fileInput.type = 'file'; fileInput.accept = '.csv';
            const handleClick = () => fileInput.click();
            const handleChange = (e) => { if (e.target.files.length > 0) handleFile(e.target.files[0]); };
            const handleDragOver = (e) => { e.preventDefault(); dropzone.classList.add('border-blue-500', 'bg-blue-50'); };
            const handleDragLeave = (e) => { e.preventDefault(); dropzone.classList.remove('border-blue-500', 'bg-blue-50'); };
            const handleDrop = (e) => { e.preventDefault(); dropzone.classList.remove('border-blue-500', 'bg-blue-50'); if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]); };
            
            dropzone.addEventListener('click', handleClick);
            fileInput.addEventListener('change', handleChange);
            dropzone.addEventListener('dragover', handleDragOver);
            dropzone.addEventListener('dragleave', handleDragLeave);
            dropzone.addEventListener('drop', handleDrop);
        }

        function setupDashboardEventListeners() {
            // Use event delegation on a stable parent
            appRoot.addEventListener('click', (e) => {
                const toggleBtn = e.target.closest('#toggle-sidebar-btn');
                const resetBtn = e.target.closest('#reset-app-btn');
                const prevPageBtn = e.target.closest('#prev-page-btn');
                const nextPageBtn = e.target.closest('#next-page-btn');
                const clearFiltersBtn = e.target.closest('#clear-filters-btn');
                const downloadCsvBtn = e.target.closest('#download-csv-btn');
                const analysisBtn = e.target.closest('#deeper-analysis-btn');
                const collapsibleHeader = e.target.closest('[data-collapsible-key]');
                const tableHeader = e.target.closest('th[data-sort-key]');

                if (toggleBtn) {
                    state.isSidebarOpen = !state.isSidebarOpen; 
                    document.getElementById('sidebar').classList.toggle('hidden');
                    document.getElementById('sidebar').classList.toggle('flex');
                    toggleBtn.innerHTML = `<span class="w-6 h-6 text-gray-600 inline-block">${state.isSidebarOpen ? icons.x : icons.filter}</span>`;
                }
                if (resetBtn) resetApp();
                if (prevPageBtn && !prevPageBtn.disabled) {
                    state.pagination.currentPage--;
                    fileParserWorker.postMessage({ type: 'request-page', filters: state.filters, pagination: state.pagination, sortConfig: state.sortConfig });
                }
                if (nextPageBtn && !nextPageBtn.disabled) {
                    state.pagination.currentPage++;
                     fileParserWorker.postMessage({ type: 'request-page', filters: state.filters, pagination: state.pagination, sortConfig: state.sortConfig });
                }
                if (clearFiltersBtn) {
                    document.querySelectorAll('#sidebar input[type="checkbox"]').forEach(cb => cb.checked = false);
                    document.querySelectorAll('#sidebar input[type="text"]').forEach(input => input.value = '');
                    document.getElementById('start-date').value = '';
                    document.getElementById('end-date').value = '';
                    state.filters = {};
                    state.pagination.currentPage = 1;
                    fileParserWorker.postMessage({ type: 'request-page', filters: state.filters, pagination: state.pagination, sortConfig: state.sortConfig });
                }
                if (downloadCsvBtn) downloadFilteredCSV();
                if (analysisBtn && !analysisBtn.disabled) {
                    openDeeperAnalysis();
                }
                if (collapsibleHeader) {
                    const container = collapsibleHeader.nextElementSibling;
                    container.classList.toggle('hidden');
                    const icon = collapsibleHeader.querySelector('.collapse-icon');
                    icon.innerHTML = container.classList.contains('hidden') ? icons.chevronRight : icons.chevronDown;
                }
                if (tableHeader) {
                    const key = tableHeader.dataset.sortKey;
                    let direction = 'ascending';
                    if(state.sortConfig.key === key && state.sortConfig.direction === 'ascending') direction = 'descending';
                    state.sortConfig = { key, direction };
                    state.pagination.currentPage = 1;
                    fileParserWorker.postMessage({ type: 'request-page', filters: state.filters, pagination: state.pagination, sortConfig: state.sortConfig });
                }
            });

            const sidebar = document.getElementById('sidebar');
            if(sidebar) {
                 sidebar.addEventListener('input', (e) => {
                    if (e.target.matches('#metric-search-input')) {
                        const searchTerm = e.target.value.toLowerCase();
                        const filterGroups = document.querySelectorAll('.metric-filter-group');
                        filterGroups.forEach(group => {
                            const label = group.querySelector('label').textContent;
                            if (label.toLowerCase().includes(searchTerm)) {
                                group.style.display = '';
                            } else {
                                group.style.display = 'none';
                            }
                        });
                    }
                    if (e.target.matches('input[type="text"][data-filter-key]')) {
                        const key = e.target.dataset.filterKey;
                        const value = e.target.value;
                        if(value) {
                            state.filters[key] = value;
                        } else {
                            delete state.filters[key];
                        }
                        state.pagination.currentPage = 1;
                        fileParserWorker.postMessage({ type: 'request-page', filters: state.filters, pagination: state.pagination, sortConfig: state.sortConfig });
                    }
                 });
                 sidebar.addEventListener('change', (e) => {
                    if (e.target.matches('input[type="checkbox"]')) {
                        const key = e.target.dataset.filterKey;
                        const checkedBoxes = document.querySelectorAll(`input[data-filter-key="${key}"]:checked`);
                        state.filters[key] = Array.from(checkedBoxes).map(cb => cb.value);
                        if (Object.values(state.filters[key]).length === 0) delete state.filters[key];
                        state.pagination.currentPage = 1; 
                        fileParserWorker.postMessage({ type: 'request-page', filters: state.filters, pagination: state.pagination, sortConfig: state.sortConfig });
                    }
                    if (e.target.matches('#start-date, #end-date')) {
                        const startDate = document.getElementById('start-date').value;
                        const endDate = document.getElementById('end-date').value;
                        state.filters.dateRange = { start: startDate, end: endDate };
                        if (!startDate && !endDate) {
                            delete state.filters.dateRange;
                        }
                        state.pagination.currentPage = 1;
                        fileParserWorker.postMessage({ type: 'request-page', filters: state.filters, pagination: state.pagination, sortConfig: state.sortConfig });
                    }
                });
            }
        }
        
        // --- TARGETED UPDATE FUNCTIONS ---
        function updateSummaryPanel() {
            document.getElementById('summary-panel').innerHTML = renderSummaryContent();
        }
        function updateDataTable() {
            document.getElementById('data-table-wrapper').innerHTML = renderTableContent();
            document.getElementById('pagination-controls-container').innerHTML = renderPaginationControls();
        }
        function updateHeader() {
            document.getElementById('header-container').innerHTML = renderHeaderContent();
            // Re-bind listener for the toggle button inside the updated header
            document.getElementById('toggle-sidebar-btn').addEventListener('click', () => {
                state.isSidebarOpen = !state.isSidebarOpen;
                document.getElementById('sidebar').classList.toggle('hidden');
                document.getElementById('sidebar').classList.toggle('flex');
                document.getElementById('toggle-sidebar-btn').innerHTML = `<span class="w-6 h-6 text-gray-600 inline-block">${state.isSidebarOpen ? icons.x : icons.filter}</span>`;
            });
        }
        function updateSidebarButtons() {
            // This function is no longer needed for the Deeper Analysis button
        }
        
        function setupAndAttachWorker() {
            fileParserWorker = setupFileParserWorker();
            fileParserWorker.onmessage = (e) => {
                const messageType = e.data.type;
                if (messageType === 'parse-success') {
                    state.headers = e.data.headers;
                    state.customMetricKeys = e.data.customMetricKeys;
                    state.filterOptions = e.data.filterOptions;
                    state.highCardinalityFields = e.data.highCardinalityFields;
                    state.summaryStats = e.data.summaryStats;
                    state.filters = {};
                    
                    fileParserWorker.postMessage({ type: 'request-page', filters: state.filters, pagination: state.pagination, sortConfig: state.sortConfig });

                } else if (messageType === 'parse-error') {
                    state.isLoading = false;
                    state.error = `Failed to parse the file: ${e.data.error}`;
                    renderApp();

                } else if (messageType === 'page-data') {
                    state.data = e.data.data;
                    state.totalFilteredRows = e.data.totalFilteredRows;
                    
                    if (e.data.filteredSummary) {
                        const totalRows = state.summaryStats.totalRows;
                        const totalContained = state.summaryStats.totalContained;
                        const avgHandleTime = state.summaryStats.avgHandleTime;
                        
                        state.summaryStats = { ...e.data.filteredSummary, totalRows, totalContained, avgHandleTime };
                    }
                    
                    if(state.isLoading) {
                        state.isLoading = false;
                        renderApp();
                    } else {
                        updateUI();
                    }
                } else if (messageType === 'csv-string-data') {
                    const blob = new Blob([e.data.csvString], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement("a");
                    link.href = URL.createObjectURL(blob);
                    link.download = `filtered_${state.fileName}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else if (messageType === 'analysis-result') {
                    renderConsumptionAnalysisModal(e.data.data);
                }
            };
        }

        // --- INITIALIZATION ---
        setupAndAttachWorker();
        renderApp();

    </script>
</body>
</html>
