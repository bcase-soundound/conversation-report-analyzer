<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation Report Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden; /* Prevent body from scrolling horizontally */
        }
        /* Custom scrollbar for filter sidebar */
        .sidebar-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 3px;
        }
        .sidebar-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* Ensure the main content area can scroll if needed, but the table has its own scroll */
        .main-content {
            height: 100vh;
            display: flex;
            flex-direction: column;
            min-width: 0; /* CRITICAL FIX: Prevents flex item from overflowing its container */
        }
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-root"></div>
    <div id="modal-root"></div>

    <script type="module">
        // --- STATE MANAGEMENT ---
        let state = {
            data: [],
            headers: [],
            customMetricKeys: [],
            filters: {},
            fileName: '',
            error: '',
            isSidebarOpen: true,
            sortConfig: { key: null, direction: 'ascending' },
            mainChartInstance: null,
            analysisChartInstances: {},
        };

        // --- ICONS (as SVG strings to avoid external dependencies) ---
        const icons = {
            uploadCloud: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>`,
            file: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>`,
            x: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            download: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
            filter: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>`,
            search: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`,
        };

        const appRoot = document.getElementById('app-root');
        const modalRoot = document.getElementById('modal-root');

        // --- RENDER FUNCTIONS ---
        
        function renderApp() {
            if (state.data.length === 0) {
                appRoot.innerHTML = renderUploader();
                setupUploaderEventListeners();
            } else {
                appRoot.innerHTML = renderDashboard();
                setupDashboardEventListeners();
            }
        }

        function renderUploader() {
            return `
                <div class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4 text-center">
                    <div id="dropzone" class="w-full max-w-lg p-10 border-2 border-dashed rounded-xl cursor-pointer transition-colors border-gray-300 bg-white hover:bg-gray-100">
                        <div class="flex flex-col items-center justify-center space-y-4 pointer-events-none">
                            <div class="bg-blue-100 p-4 rounded-full">
                                <span class="w-10 h-10 text-blue-600 inline-block">${icons.uploadCloud.replace('width="24"','width="40"').replace('height="24"','height="40"')}</span>
                            </div>
                            <p class="text-lg font-semibold text-gray-700">Drag & drop your CSV file here</p>
                            <p class="text-sm text-gray-500">or</p>
                            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                                Browse files
                            </button>
                            <p class="text-xs text-gray-400 mt-2">Only *.csv files are accepted</p>
                        </div>
                    </div>
                    ${state.error ? `<p class="text-red-500 mt-4">${state.error}</p>` : ''}
                    <div class="mt-8 text-left max-w-lg w-full">
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Welcome to the Conversation Analyzer</h3>
                        <p class="text-gray-600">This tool helps you process and analyze conversation reports. Simply upload your CSV file to get started.</p>
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const filteredData = getFilteredData();
            return `
                <div class="min-h-screen font-sans flex">
                    ${state.isSidebarOpen ? renderSidebar(filteredData) : ''}
                    <main class="flex-1 p-6 md:p-8 main-content">
                        ${renderHeader()}
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-shrink-0">
                            <div class="lg:col-span-2">
                                ${renderSummaryPanel(filteredData)}
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                ${renderMainChart(filteredData)}
                            </div>
                        </div>
                        <div class="mt-6 bg-white rounded-xl shadow-md flex-grow flex flex-col overflow-hidden">
                            ${renderDataTable(filteredData)}
                        </div>
                    </main>
                </div>
            `;
        }

        function renderSidebar(filteredData) {
            const options = getFilterOptions();
            const standardKeys = Object.keys(options).filter(k => !state.customMetricKeys.includes(k));
            const customKeys = state.customMetricKeys.filter(k => options[k]);
            const hasActiveFilters = Object.values(state.filters).some(v => v !== '');

            const renderSelect = (key) => `
                <div key="${key}">
                    <label class="block text-sm font-medium text-gray-600 mb-1">${key}</label>
                    <select data-filter-key="${key}" class="w-full p-2 border border-gray-300 rounded-md bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All</option>
                        ${options[key]?.map(opt => `<option value="${opt}" ${state.filters[key] === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                </div>
            `;

            return `
                <aside class="w-80 bg-white p-6 border-r border-gray-200 flex flex-col shadow-lg" style="height: 100vh;">
                    <div class="flex-grow overflow-y-auto sidebar-scroll pr-2">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"><span class="mr-2 text-blue-600">${icons.filter}</span>Filters</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <h3 class="w-full flex justify-between items-center text-lg font-semibold text-gray-700 mb-2">Standard Metrics</h3>
                                <div class="space-y-4 pl-2 border-l-2 border-blue-200">
                                    ${standardKeys.map(renderSelect).join('')}
                                </div>
                            </div>
                            ${customKeys.length > 0 ? `
                            <div>
                                <h3 class="w-full flex justify-between items-center text-lg font-semibold text-gray-700 mb-2">Custom Metrics</h3>
                                <div class="space-y-4 pl-2 border-l-2 border-green-200">
                                    ${customKeys.map(renderSelect).join('')}
                                </div>
                            </div>` : ''}
                        </div>
                    </div>
                    <div class="flex-shrink-0 pt-4 border-t mt-4 space-y-2">
                         <button id="deeper-analysis-btn" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-colors flex items-center justify-center ${!hasActiveFilters ? 'opacity-50 cursor-not-allowed' : ''}" ${!hasActiveFilters ? 'disabled' : ''}>
                            <span class="w-5 h-5 mr-2">${icons.search}</span>
                            Deeper Analysis
                        </button>
                         <button id="download-csv-btn" class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition-colors flex items-center justify-center">
                            <span class="w-5 h-5 mr-2">${icons.download}</span>
                            Download Filtered
                        </button>
                        <button id="clear-filters-btn" class="w-full py-2 px-4 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-semibold transition-colors">
                            Clear All Filters
                        </button>
                    </div>
                </aside>
            `;
        }
        
        function renderHeader() {
            const activeFilters = Object.entries(state.filters).filter(([key, value]) => value !== '');
            return `
                <div class="flex-shrink-0">
                    <header class="flex justify-between items-center mb-6">
                        <div class="flex items-center">
                            <button id="toggle-sidebar-btn" class="p-2 rounded-md hover:bg-gray-200 mr-4">
                                <span class="w-6 h-6 text-gray-600 inline-block">${state.isSidebarOpen ? icons.x : icons.filter}</span>
                            </button>
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800">Conversation Analysis</h1>
                                <div class="flex items-center text-sm text-gray-500 mt-1">
                                    <span class="w-4 h-4 mr-2 inline-block">${icons.file}</span>
                                    <span>${state.fileName}</span>
                                </div>
                            </div>
                        </div>
                        <button id="reset-app-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition-colors flex items-center">
                            <span class="w-5 h-5 mr-2 inline-block">${icons.uploadCloud}</span> Upload New File
                        </button>
                    </header>
                    ${activeFilters.length > 0 ? `
                    <div class="mb-4">
                        <h3 class="text-sm font-semibold text-gray-600 mb-2">Active Filters:</h3>
                        <div class="flex flex-wrap gap-2">
                            ${activeFilters.map(([key, value]) => `
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                    <strong>${key}:</strong>&nbsp;${value}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function renderSummaryPanel(filteredData) {
            const dates = state.data.map(row => parseDate(row.Created)).filter(d => d);
            const minDate = dates.length > 0 ? new Date(Math.min.apply(null, dates)) : null;
            const maxDate = dates.length > 0 ? new Date(Math.max.apply(null, dates)) : null;
            const timeRange = minDate && maxDate ? `${minDate.toLocaleDateString()} - ${maxDate.toLocaleDateString()}` : 'N/A';
            const uniqueDomains = new Set(state.data.map(r => r.Domain)).size;

            const summaryCard = (title, value) => `
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500">${title}</h3>
                    <p class="text-2xl font-bold text-gray-800 mt-1">${value}</p>
                </div>
            `;

            return `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${summaryCard('Time Range', timeRange)}
                    ${summaryCard('Total Conversations', state.data.length.toLocaleString())}
                    ${summaryCard('Filtered Conversations', filteredData.length.toLocaleString())}
                    ${summaryCard('Unique Domains', uniqueDomains.toLocaleString())}
                </div>
            `;
        }
        
        function renderMainChart(filteredData) {
            const total = state.data.length;
            const filtered = filteredData.length;
            const percentage = total > 0 ? ((filtered / total) * 100).toFixed(1) : 0;

            return `
                <div class="flex flex-col h-full">
                    <h3 class="text-center font-semibold text-gray-700">Filtered vs. Total</h3>
                    <div class="flex-grow flex items-center justify-center relative">
                         <canvas id="main-pie-chart"></canvas>
                         <div class="absolute text-center pointer-events-none">
                            <span class="text-3xl font-bold text-blue-600">${percentage}%</span>
                            <p class="text-sm text-gray-500">Filtered</p>
                         </div>
                    </div>
                </div>
            `;
        }

        function renderDataTable(filteredData) {
            const sortedData = getSortedData(filteredData);
            const displayHeaders = state.headers.filter(h => h !== 'Custom Metrics');
            
            const getSortIndicator = (key) => {
                if (state.sortConfig.key !== key) return '';
                return state.sortConfig.direction === 'ascending' ? ' ▲' : ' ▼';
            };

            return `
                <div class="relative overflow-auto flex-grow">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10">
                            <tr>
                                ${displayHeaders.map(header => `
                                    <th data-sort-key="${header}" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer whitespace-nowrap">
                                        ${header}${getSortIndicator(header)}
                                    </th>
                                `).join('')}
                                ${state.customMetricKeys.map(key => `
                                    <th data-sort-key="${key}" class="px-6 py-3 text-left text-xs font-medium text-green-600 bg-green-50 uppercase tracking-wider cursor-pointer whitespace-nowrap">
                                        ${key}${getSortIndicator(key)}
                                    </th>
                                `).join('')}
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${sortedData.length > 0 ? sortedData.map((row, index) => `
                                <tr class="hover:bg-gray-50">
                                    ${displayHeaders.map(header => `
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${String(row[header] ?? '')}</td>
                                    `).join('')}
                                    ${state.customMetricKeys.map(key => `
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700 bg-green-50">${String(row[key] ?? '')}</td>
                                    `).join('')}
                                </tr>
                            `).join('') : `
                                <tr>
                                    <td colspan="${displayHeaders.length + state.customMetricKeys.length}" class="text-center py-10 text-gray-500">
                                        No conversations match the current filters.
                                    </td>
                                </tr>
                            `}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function renderAnalysisModal(filteredData) {
             modalRoot.innerHTML = `
                <div id="analysis-modal-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 p-4 opacity-0">
                    <div id="analysis-modal-container" class="bg-white rounded-2xl shadow-2xl w-full max-w-6xl transform scale-95">
                        <div class="p-6 border-b flex justify-between items-center">
                            <h2 class="text-2xl font-bold text-gray-800">Deeper Analysis of Filtered Results</h2>
                            <button id="close-modal-btn" class="p-2 rounded-full hover:bg-gray-200">
                                <span class="w-6 h-6 text-gray-600 inline-block">${icons.x}</span>
                            </button>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" style="max-height: 75vh; overflow-y: auto;">
                            <!-- Chart containers -->
                            <div class="bg-gray-50 p-4 rounded-xl"><h3 class="text-center font-semibold text-gray-700 mb-2">Amelia Handled</h3><canvas id="amelia-handled-chart"></canvas></div>
                            <div class="bg-gray-50 p-4 rounded-xl"><h3 class="text-center font-semibold text-gray-700 mb-2">Escalated</h3><canvas id="escalated-chart"></canvas></div>
                            <div class="bg-gray-50 p-4 rounded-xl md:col-span-2 lg:col-span-1"><h3 class="text-center font-semibold text-gray-700 mb-2">Conversation Volume</h3><canvas id="volume-chart"></canvas></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Trigger animations
            setTimeout(() => {
                document.getElementById('analysis-modal-overlay').classList.remove('opacity-0');
                document.getElementById('analysis-modal-container').classList.remove('scale-95');
            }, 10);

            setupAnalysisCharts(filteredData);
            document.getElementById('close-modal-btn').addEventListener('click', closeAnalysisModal);
            document.getElementById('analysis-modal-overlay').addEventListener('click', (e) => {
                if (e.target.id === 'analysis-modal-overlay') {
                    closeAnalysisModal();
                }
            });
        }

        function closeAnalysisModal() {
            const overlay = document.getElementById('analysis-modal-overlay');
            const container = document.getElementById('analysis-modal-container');
            if (overlay) {
                 overlay.classList.add('opacity-0');
                 container.classList.add('scale-95');
                 setTimeout(() => {
                    modalRoot.innerHTML = '';
                    Object.values(state.analysisChartInstances).forEach(chart => chart.destroy());
                    state.analysisChartInstances = {};
                 }, 300);
            }
        }


        // --- LOGIC & DATA HANDLING ---

        function parseDate(dateString) {
            if (!dateString) return null;
            const cleanDateString = dateString.replace(/\[.*\]/, '');
            const date = new Date(cleanDateString);
            return isNaN(date) ? null : date;
        }

        function getFilteredData() {
            return state.data.filter(row => {
                return Object.entries(state.filters).every(([key, value]) => {
                    if (value === '') return true;
                    return String(row[key]) === String(value);
                });
            });
        }
        
        function getSortedData(data) {
            let sortableData = [...data];
            const { key, direction } = state.sortConfig;
            if (key !== null) {
                sortableData.sort((a, b) => {
                    const valA = a[key];
                    const valB = b[key];
                    if (valA < valB) return direction === 'ascending' ? -1 : 1;
                    if (valA > valB) return direction === 'ascending' ? 1 : -1;
                    return 0;
                });
            }
            return sortableData;
        }

        function getFilterOptions() {
            if (state.data.length === 0) return {};
            const options = {};
            const filterableColumns = ['Domain', 'Status', 'Channel', 'Escalated', 'Amelia Handled', 'Agent Handled', ...state.customMetricKeys];
            filterableColumns.forEach(header => {
                const uniqueValues = [...new Set(state.data.map(row => row[header]).filter(val => val != null && val !== ''))];
                if (uniqueValues.length > 0) {
                    options[header] = uniqueValues.sort();
                }
            });
            return options;
        }

        function handleFile(file) {
            if (file.type !== 'text/csv') {
                state.error = 'Invalid file type. Please upload a CSV file.';
                renderApp();
                return;
            }
            state.fileName = file.name;
            state.error = '';

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: (results) => {
                    const parsedData = results.data.map(row => {
                        const customMetricsRaw = row['Custom Metrics'] || '';
                        const customMetrics = {};
                        if (customMetricsRaw) {
                            customMetricsRaw.split('||').forEach(metric => {
                                const [key, value] = metric.split('=');
                                if (key) {
                                    customMetrics[key.trim()] = value ? value.trim() : null;
                                }
                            });
                        }
                        return { ...row, ...customMetrics };
                    });

                    state.data = parsedData;
                    state.headers = results.meta.fields;
                    const newCustomMetricKeys = new Set();
                    parsedData.forEach(row => {
                        Object.keys(row).forEach(key => {
                            if (!state.headers.includes(key)) {
                                newCustomMetricKeys.add(key);
                            }
                        });
                    });
                    state.customMetricKeys = Array.from(newCustomMetricKeys);
                    state.filters = {};
                    renderApp();
                }
            });
        }
        
        function resetApp() {
            if (state.mainChartInstance) {
                state.mainChartInstance.destroy();
                state.mainChartInstance = null;
            }
            closeAnalysisModal();
            state.data = [];
            state.headers = [];
            state.customMetricKeys = [];
            state.filters = {};
            state.fileName = '';
            state.error = '';
            renderApp();
        }

        function downloadFilteredCSV() {
            const filteredData = getFilteredData();
            if (filteredData.length === 0) {
                alert("No data to download.");
                return;
            }

            const allHeaders = [...state.headers.filter(h => h !== 'Custom Metrics'), ...state.customMetricKeys];
            
            const csv = Papa.unparse({
                fields: allHeaders,
                data: filteredData
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `filtered_${state.fileName}`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function setupMainChart() {
            const chartEl = document.getElementById('main-pie-chart');
            if (!chartEl) return;
            
            if (state.mainChartInstance) {
                state.mainChartInstance.destroy();
            }

            const filteredData = getFilteredData();
            const total = state.data.length;
            const filtered = filteredData.length;
            const others = total - filtered;

            const chartData = {
                labels: ['Filtered Conversations', 'Other Conversations'],
                datasets: [{
                    data: [filtered, others],
                    backgroundColor: ['#3b82f6', '#e5e7eb'],
                    hoverBackgroundColor: ['#2563eb', '#d1d5db'],
                    borderWidth: 0,
                }]
            };

            state.mainChartInstance = new Chart(chartEl.getContext('2d'), {
                type: 'doughnut',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true
                        }
                    }
                }
            });
        }
        
        function setupAnalysisCharts(filteredData) {
            // Amelia Handled Chart
            const ameliaHandled = filteredData.filter(r => r['Amelia Handled'] === 'true').length;
            createPieChart('amelia-handled-chart', ['Amelia Handled', 'Agent Involved'], [ameliaHandled, filteredData.length - ameliaHandled], ['#10b981', '#fecaca']);

            // Escalated Chart
            const escalated = filteredData.filter(r => r['Escalated'] === 'true').length;
            createPieChart('escalated-chart', ['Escalated', 'Not Escalated'], [escalated, filteredData.length - escalated], ['#f97316', '#dbeafe']);
            
            // Volume Chart
            const volumeByDate = filteredData.reduce((acc, row) => {
                const date = parseDate(row.Created)?.toLocaleDateString();
                if (date) {
                    acc[date] = (acc[date] || 0) + 1;
                }
                return acc;
            }, {});
            
            const sortedDates = Object.keys(volumeByDate).sort((a, b) => new Date(a) - new Date(b));
            const volumeLabels = sortedDates;
            const volumeData = sortedDates.map(date => volumeByDate[date]);
            createLineChart('volume-chart', volumeLabels, volumeData);
        }
        
        function createPieChart(canvasId, labels, data, colors) {
            const chartEl = document.getElementById(canvasId);
            if (!chartEl) return;
            
            state.analysisChartInstances[canvasId] = new Chart(chartEl.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }
        
        function createLineChart(canvasId, labels, data) {
            const chartEl = document.getElementById(canvasId);
            if (!chartEl) return;
            
            state.analysisChartInstances[canvasId] = new Chart(chartEl.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conversations',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { precision: 0 } },
                        x: { ticks: { maxRotation: 45, minRotation: 45 } }
                    }
                }
            });
        }


        // --- EVENT LISTENERS ---

        function setupUploaderEventListeners() {
            const dropzone = document.getElementById('dropzone');
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.csv';

            dropzone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('border-blue-500', 'bg-blue-50');
            });
            dropzone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-blue-500', 'bg-blue-50');
            });
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('border-blue-500', 'bg-blue-50');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
        }

        function setupDashboardEventListeners() {
            document.getElementById('toggle-sidebar-btn').addEventListener('click', () => {
                state.isSidebarOpen = !state.isSidebarOpen;
                renderApp();
            });

            document.getElementById('reset-app-btn').addEventListener('click', resetApp);
            
            document.querySelectorAll('[data-filter-key]').forEach(select => {
                select.addEventListener('change', (e) => {
                    const key = e.target.dataset.filterKey;
                    const value = e.target.value;
                    state.filters[key] = value;
                    renderApp();
                });
            });

            const clearFiltersBtn = document.getElementById('clear-filters-btn');
            if(clearFiltersBtn) clearFiltersBtn.addEventListener('click', () => {
                state.filters = {};
                renderApp();
            });

            const downloadBtn = document.getElementById('download-csv-btn');
            if(downloadBtn) downloadBtn.addEventListener('click', downloadFilteredCSV);

            const analysisBtn = document.getElementById('deeper-analysis-btn');
            if(analysisBtn) analysisBtn.addEventListener('click', () => {
                renderAnalysisModal(getFilteredData());
            });
            
            document.querySelectorAll('[data-sort-key]').forEach(th => {
                th.addEventListener('click', (e) => {
                    const key = e.currentTarget.dataset.sortKey;
                    let direction = 'ascending';
                    if(state.sortConfig.key === key && state.sortConfig.direction === 'ascending') {
                        direction = 'descending';
                    }
                    state.sortConfig = { key, direction };
                    renderApp();
                });
            });
            
            setupMainChart();
        }

        // --- INITIAL RENDER ---
        renderApp();

    </script>
</body>
</html>
